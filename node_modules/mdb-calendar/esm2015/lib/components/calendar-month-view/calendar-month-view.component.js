import { Component, Input, EventEmitter, Output, Renderer2, ViewChildren, } from '@angular/core';
import { getDaysInMonth, startOfDay, endOfDay, isToday, isWeekend, format, startOfWeek, getDate, } from 'date-fns';
import { getMonthDayEvents } from '../../utils/event-utils';
export class MdbCalendarMonthViewComponent {
    constructor(renderer) {
        this.renderer = renderer;
        this.weekDayIndex = 0;
        this.dayClicked = new EventEmitter();
        this.eventClicked = new EventEmitter();
        this.viewChanged = new EventEmitter();
        this.monthChanged = new EventEmitter();
        this.allCells = [];
        this.dates = [];
        this._isInitialized = false;
    }
    get initDate() {
        return this._initDate;
    }
    set initDate(date) {
        this._initDate = date;
        if (this._isInitialized) {
            const currentYear = date.getFullYear();
            const currentMonth = date.getMonth();
            this.createMonthView(currentYear, currentMonth);
        }
    }
    get events() {
        return this._events;
    }
    set events(events) {
        this._events = events;
        this.dates.forEach((week) => {
            week.week.forEach((day) => {
                day.events = getMonthDayEvents(events, day.startOfDay, day.endOfDay);
            });
        });
    }
    ngOnInit() {
        const currentYear = this.initDate.getFullYear();
        const currentMonth = this.initDate.getMonth();
        this.createMonthView(currentYear, currentMonth);
        this._isInitialized = true;
    }
    ngAfterViewInit() {
        this.allCells = this.days.toArray().map((el) => el.nativeElement);
    }
    trackByFn(index) {
        return index;
    }
    trackByEvent(index, item) {
        return item.id;
    }
    trackByDay(index, item) {
        return item.dayNumber;
    }
    onMouseDown(event, day) {
        this.dragStart = this.allCells.indexOf(event.target);
        this.isDragging = true;
        this.selectionStartDate = day.startOfDay;
    }
    onMouseUp(event, day) {
        this.dragEnd = this.allCells.indexOf(event.target);
        this.selectionEndDate = day.endOfDay;
        const calendarEvent = {
            name: 'New event',
            startDate: this.selectionStartDate,
            endDate: this.selectionEndDate,
            color: 'info',
        };
        if (this.dragStart !== this.dragEnd) {
            this.dayClicked.emit(calendarEvent);
        }
        this.isDragging = false;
        if (this.dragEnd !== 0) {
            this.selectRange();
        }
        this.clearSelection();
    }
    selectRange() {
        this.clearSelection();
        if (this.dragEnd > this.dragStart) {
            if (this.dragEnd + 1 < this.dragStart) {
                this.allCells
                    .slice(this.dragEnd, this.dragStart + 1)
                    .forEach((cell) => this.renderer.setStyle(cell, 'background-color', 'rgba(69,82,110,.3)'));
            }
            else {
                this.allCells
                    .slice(this.dragStart, this.dragEnd + 1)
                    .forEach((cell) => this.renderer.setStyle(cell, 'background-color', 'rgba(69,82,110,.3)'));
            }
        }
    }
    clearSelection() {
        this.allCells.forEach((cell) => this.renderer.removeStyle(cell, 'background-color'));
    }
    onMouseMove(event) {
        event.preventDefault();
        if (this.isDragging) {
            this.dragEnd = this.allCells.indexOf(event.target);
            this.selectRange();
        }
    }
    onDayClick(day) {
        const newEvent = {
            name: 'New event',
            startDate: day.startOfDay,
            endDate: day.endOfDay,
            color: 'info',
        };
        this.dayClicked.emit(newEvent);
    }
    onEventClick(event) {
        const eventCopy = {
            id: event.id,
            name: event.name,
            startDate: format(event.startDate, 'YYYY-MM-DD, HH:mm:ss'),
            endDate: format(event.endDate, 'YYYY-MM-DD, HH:mm:ss'),
            color: event.color,
        };
        this.eventClicked.emit(eventCopy);
    }
    onViewChange(view) {
        this.viewChanged.emit(view);
    }
    next() {
        if (this.selectedMonth === 11) {
            this.createMonthView(this.selectedYear + 1, 0);
        }
        else {
            this.createMonthView(this.selectedYear, this.selectedMonth + 1);
        }
        this.monthChanged.emit({
            index: this.selectedMonth,
            month: this.months[this.selectedMonth],
            year: this.selectedYear,
        });
    }
    previous() {
        if (this.selectedMonth === 0) {
            this.createMonthView(this.selectedYear - 1, 11);
        }
        else {
            this.createMonthView(this.selectedYear, this.selectedMonth - 1);
        }
        this.monthChanged.emit({
            index: this.selectedMonth,
            month: this.months[this.selectedMonth],
            year: this.selectedYear,
        });
    }
    goToToday() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        this.createMonthView(currentYear, currentMonth);
        this.monthChanged.emit({
            index: this.selectedMonth,
            name: this.months[this.selectedMonth],
            year: this.selectedYear,
        });
    }
    getDaysInPreviousMonth(year, month) {
        if (month === -1) {
            return getDaysInMonth(new Date(year - 1, 11));
        }
        return getDaysInMonth(new Date(year, month));
    }
    createMonthView(year, month) {
        this.selectedMonth = month;
        this.selectedYear = year;
        const daysInMonth = getDaysInMonth(new Date(year, month));
        const daysInPreviousMonth = this.getDaysInPreviousMonth(year, month - 1);
        const firstDay = startOfWeek(new Date(year, month), { weekStartsOn: this.weekDayIndex });
        const firstVisibleDay = getDate(firstDay);
        let dayStart;
        let dayEnd;
        const dates = [];
        let dayNumber = 1;
        let monthNumber = month;
        for (let i = 1; i < 7; i++) {
            const week = [];
            if (i === 1 && firstVisibleDay !== 1) {
                for (let j = firstVisibleDay; j <= daysInPreviousMonth; j++) {
                    dayStart = startOfDay(new Date(year, month - 1, j));
                    dayEnd = endOfDay(new Date(year, month - 1, j));
                    week.push({
                        dayNumber: j,
                        isToday: false,
                        isWeekend: isWeekend(new Date(year, month - 1, j)),
                        month: month - 1,
                        startOfDay: startOfDay(new Date(year, month - 1, j)),
                        endOfDay: endOfDay(new Date(year, month - 1, j)),
                        events: getMonthDayEvents(this.events, dayStart, dayEnd),
                    });
                }
                const daysLeft = 7 - week.length;
                for (let j = 0; j < daysLeft; j++) {
                    dayStart = startOfDay(new Date(year, month, dayNumber));
                    dayEnd = endOfDay(new Date(year, month, dayNumber));
                    week.push({
                        dayNumber: dayNumber,
                        isToday: isToday(new Date(year, month, dayNumber)),
                        isWeekend: isWeekend(new Date(year, month, dayNumber)),
                        month: month,
                        startOfDay: startOfDay(new Date(year, month, dayNumber)),
                        endOfDay: endOfDay(new Date(year, month, dayNumber)),
                        events: getMonthDayEvents(this.events, dayStart, dayEnd),
                    });
                    dayNumber++;
                }
            }
            else {
                for (let j = 1; j < 8; j++) {
                    if (dayNumber > daysInMonth) {
                        dayNumber = 1;
                        monthNumber = month + 1;
                    }
                    dayStart = startOfDay(new Date(year, monthNumber, dayNumber));
                    dayEnd = endOfDay(new Date(year, monthNumber, dayNumber));
                    week.push({
                        dayNumber: dayNumber,
                        isToday: isToday(new Date(year, monthNumber, dayNumber)),
                        isWeekend: isWeekend(new Date(year, monthNumber, dayNumber)),
                        month: monthNumber,
                        startOfDay: startOfDay(new Date(year, monthNumber, dayNumber)),
                        endOfDay: endOfDay(new Date(year, monthNumber, dayNumber)),
                        events: getMonthDayEvents(this.events, dayStart, dayEnd),
                    });
                    dayNumber++;
                }
            }
            dates.push({ week });
        }
        this.dates = dates;
    }
}
MdbCalendarMonthViewComponent.decorators = [
    { type: Component, args: [{
                selector: 'mdb-calendar-month-view',
                template: "<div class=\"mdb-month-view\">\n  <div class=\"mdb-calendar-tools d-flex justify-content-between mb-3\">\n    <div class=\"btn-group btn-group-sm\" role=\"group\">\n      <button\n        mdbBtn\n        color=\"info\"\n        outline=\"true\"\n        class=\"mdb-calendar-previous-btn px-4\"\n        (click)=\"previous()\"\n      >\n        <mdb-icon fas icon=\"chevron-left\"></mdb-icon>\n      </button>\n      <button\n        mdbBtn\n        color=\"info\"\n        outline=\"true\"\n        class=\"mdb-calendar-next-btn px-4\"\n        (click)=\"next()\"\n      >\n        <mdb-icon fas icon=\"chevron-right\"></mdb-icon>\n      </button>\n      <button\n        mdbBtn\n        color=\"info\"\n        outline=\"true\"\n        class=\"mdb-calendar-today-btn px-4\"\n        (click)=\"goToToday()\"\n      >\n        {{ options.todayBtnTxt }}\n      </button>\n    </div>\n    <h2 class=\"mdb-calendar-heading\">{{ months[selectedMonth] }} {{ selectedYear }}</h2>\n    <div class=\"btn-group btn-group-sm\" role=\"group\">\n      <button\n        mdbBtn\n        color=\"info\"\n        outline=\"true\"\n        class=\"mdb-calendar-month-btn px-4\"\n        (click)=\"onViewChange('month')\"\n      >\n        {{ options.monthViewBtnTxt }}\n      </button>\n      <button\n        mdbBtn\n        color=\"info\"\n        outline=\"true\"\n        class=\"mdb-calendar-week-btn px-4\"\n        (click)=\"onViewChange('week')\"\n      >\n        {{ options.weekViewBtnTxt }}\n      </button>\n      <button\n        mdbBtn\n        color=\"info\"\n        outline=\"true\"\n        class=\"mdb-calendar-list-btn px-4\"\n        (click)=\"onViewChange('list')\"\n      >\n        {{ options.listViewBtnTxt }}\n      </button>\n    </div>\n  </div>\n  <table>\n    <thead>\n      <th *ngFor=\"let day of weekDaysShort; trackBy: trackByFn\">{{ day }}</th>\n    </thead>\n\n    <tbody>\n      <tr *ngFor=\"let week of dates; trackBy: trackByFn\">\n        <td\n          #dayEl\n          *ngFor=\"let day of week.week; trackBy: trackByFn\"\n          [ngClass]=\"{\n            'mdb-today-cell': day.isToday,\n            'rgba-mdb-color-slight': day.isWeekend && !day.isToday\n          }\"\n          (click)=\"onDayClick(day)\"\n          (mousedown)=\"onMouseDown($event, day)\"\n          (mouseup)=\"onMouseUp($event, day)\"\n          (mouseenter)=\"onMouseMove($event)\"\n        >\n          <span class=\"mdb-day-field\" [ngClass]=\"{ 'text-light': day.month !== selectedMonth }\">{{\n            day.dayNumber\n          }}</span>\n          <div\n            class=\"mdb-event mdb-event-long text-white small px-1 bg-{{ event.color }}\"\n            [ngClass]=\"{\n              'mdb-event-long': event.longEvent && !event.eventStart && !event.eventEnd,\n              'mdb-event-start': event.longEvent && event.eventStart,\n              'mdb-event-end': event.longEvent && event.eventEnd,\n              'mdb-event-single': !event.longEvent\n            }\"\n            mdbTooltip=\"{{ event.name }}\"\n            placement=\"top\"\n            *ngFor=\"let event of day.events; trackBy: trackByEvent\"\n            (click)=\"onEventClick(event); $event.stopPropagation()\"\n          >\n            <span>{{ event.name }}</span>\n          </div>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n",
                styles: [".mdb-today-cell{background-color:#e1f5fe}.mdb-month-view table{table-layout:fixed;width:100%}.mdb-month-view table th{text-align:center!important;height:30px;font-weight:700;border:1px solid #ddd}.mdb-month-view table td{height:12vh;padding-top:25px;vertical-align:top;position:relative;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none;border:1px solid #ddd}.mdb-month-view table td:hover{background-color:#45526e0d!important}.mdb-day-field{position:absolute;right:8px;top:5px}.mdb-event{cursor:pointer;font-weight:700;text-align:left!important}.mdb-event-start{margin:1px -2px 1px 2px}.mdb-event-end{margin:1px 2px 1px -2px;text-indent:-9999px}.mdb-event-long{margin:1px -2px;text-indent:-9999px}.mdb-event-single{margin:1px 2px}\n"]
            },] }
];
MdbCalendarMonthViewComponent.ctorParameters = () => [
    { type: Renderer2 }
];
MdbCalendarMonthViewComponent.propDecorators = {
    days: [{ type: ViewChildren, args: ['dayEl',] }],
    initDate: [{ type: Input }],
    events: [{ type: Input }],
    weekDaysShort: [{ type: Input }],
    months: [{ type: Input }],
    weekDayIndex: [{ type: Input }],
    options: [{ type: Input }],
    dayClicked: [{ type: Output }],
    eventClicked: [{ type: Output }],
    viewChanged: [{ type: Output }],
    monthChanged: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXItbW9udGgtdmlldy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9tZGItY2FsZW5kYXIvc3JjL2xpYi9jb21wb25lbnRzL2NhbGVuZGFyLW1vbnRoLXZpZXcvY2FsZW5kYXItbW9udGgtdmlldy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFFVCxLQUFLLEVBQ0wsWUFBWSxFQUNaLE1BQU0sRUFDTixTQUFTLEVBR1QsWUFBWSxHQUViLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFDTCxjQUFjLEVBQ2QsVUFBVSxFQUNWLFFBQVEsRUFDUixPQUFPLEVBQ1AsU0FBUyxFQUNULE1BQU0sRUFDTixXQUFXLEVBQ1gsT0FBTyxHQUNSLE1BQU0sVUFBVSxDQUFDO0FBQ2xCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBUTVELE1BQU0sT0FBTyw2QkFBNkI7SUF5RHhDLFlBQW9CLFFBQW1CO1FBQW5CLGFBQVEsR0FBUixRQUFRLENBQVc7UUF4QjlCLGlCQUFZLEdBQUcsQ0FBQyxDQUFDO1FBR2hCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBQ3JDLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN2QyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFDekMsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBUWpELGFBQVEsR0FBa0IsRUFBRSxDQUFDO1FBRTdCLFVBQUssR0FBRyxFQUFFLENBQUM7UUFNSCxtQkFBYyxHQUFHLEtBQUssQ0FBQztJQUVXLENBQUM7SUF0RDNDLElBQ0ksUUFBUTtRQUNWLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDO0lBQ0QsSUFBSSxRQUFRLENBQUMsSUFBVTtRQUNyQixJQUFJLENBQUMsU0FB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Tzt1QkFFcEIsS0FBSztxQkFlTCxLQUFLOzRCQWFMLEtBQUs7cUJBQ0wsS0FBSzsyQkFDTCxLQUFLO3NCQUNMLEtBQUs7eUJBRUwsTUFBTTsyQkFDTixNQUFNOzBCQUNOLE1BQU07MkJBQ04sTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgT25Jbml0LFxuICBJbnB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBPdXRwdXQsXG4gIFJlbmRlcmVyMixcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q2hpbGRyZW4sXG4gIEVsZW1lbnRSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ2FsZW5kYXJFdmVudCB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvY2FsZW5kYXItZXZlbnQuaW50ZXJmYWNlJztcbmltcG9ydCB7XG4gIGdldERheXNJbk1vbnRoLFxuICBzdGFydE9mRGF5LFxuICBlbmRPZkRheSxcbiAgaXNUb2RheSxcbiAgaXNXZWVrZW5kLFxuICBmb3JtYXQsXG4gIHN0YXJ0T2ZXZWVrLFxuICBnZXREYXRlLFxufSBmcm9tICdkYXRlLWZucyc7XG5pbXBvcnQgeyBnZXRNb250aERheUV2ZW50cyB9IGZyb20gJy4uLy4uL3V0aWxzL2V2ZW50LXV0aWxzJztcbmltcG9ydCB7IE1kYkNhbGVuZGFyT3B0aW9ucyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvY2FsZW5kYXItb3B0aW9ucy5pbnRlcmZhY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdtZGItY2FsZW5kYXItbW9udGgtdmlldycsXG4gIHRlbXBsYXRlVXJsOiAnLi9jYWxlbmRhci1tb250aC12aWV3LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY2FsZW5kYXItbW9udGgtdmlldy5jb21wb25lbnQuc2NzcyddLFxufSlcbmV4cG9ydCBjbGFzcyBNZGJDYWxlbmRhck1vbnRoVmlld0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG4gIEBWaWV3Q2hpbGRyZW4oJ2RheUVsJykgZGF5czogUXVlcnlMaXN0PEVsZW1lbnRSZWY+O1xuXG4gIEBJbnB1dCgpXG4gIGdldCBpbml0RGF0ZSgpOiBEYXRlIHtcbiAgICByZXR1cm4gdGhpcy5faW5pdERhdGU7XG4gIH1cbiAgc2V0IGluaXREYXRlKGRhdGU6IERhdGUpIHtcbiAgICB0aGlzLl9pbml0RGF0ZSA9IGRhdGU7XG5cbiAgICBpZiAodGhpcy5faXNJbml0aWFsaXplZCkge1xuICAgICAgY29uc3QgY3VycmVudFllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgICBjb25zdCBjdXJyZW50TW9udGggPSBkYXRlLmdldE1vbnRoKCk7XG4gICAgICB0aGlzLmNyZWF0ZU1vbnRoVmlldyhjdXJyZW50WWVhciwgY3VycmVudE1vbnRoKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBfaW5pdERhdGU6IERhdGU7XG5cbiAgQElucHV0KClcbiAgZ2V0IGV2ZW50cygpIHtcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRzO1xuICB9XG4gIHNldCBldmVudHMoZXZlbnRzOiBDYWxlbmRhckV2ZW50W10pIHtcbiAgICB0aGlzLl9ldmVudHMgPSBldmVudHM7XG4gICAgdGhpcy5kYXRlcy5mb3JFYWNoKCh3ZWVrKSA9PiB7XG4gICAgICB3ZWVrLndlZWsuZm9yRWFjaCgoZGF5KSA9PiB7XG4gICAgICAgIGRheS5ldmVudHMgPSBnZXRNb250aERheUV2ZW50cyhldmVudHMsIGRheS5zdGFydE9mRGF5LCBkYXkuZW5kT2ZEYXkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfZXZlbnRzOiBDYWxlbmRhckV2ZW50W107XG4gIEBJbnB1dCgpIHdlZWtEYXlzU2hvcnQ6IHN0cmluZ1tdO1xuICBASW5wdXQoKSBtb250aHM6IHN0cmluZ1tdO1xuICBASW5wdXQoKSB3ZWVrRGF5SW5kZXggPSAwO1xuICBASW5wdXQoKSBvcHRpb25zOiBNZGJDYWxlbmRhck9wdGlvbnM7XG5cbiAgQE91dHB1dCgpIGRheUNsaWNrZWQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgpIGV2ZW50Q2xpY2tlZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCkgdmlld0NoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgQE91dHB1dCgpIG1vbnRoQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIHNlbGVjdGVkTW9udGg6IG51bWJlcjtcbiAgc2VsZWN0ZWRZZWFyOiBudW1iZXI7XG5cbiAgc2VsZWN0aW9uU3RhcnREYXRlOiBEYXRlO1xuICBzZWxlY3Rpb25FbmREYXRlOiBEYXRlO1xuXG4gIGFsbENlbGxzOiBIVE1MRWxlbWVudFtdID0gW107XG5cbiAgZGF0ZXMgPSBbXTtcblxuICBkcmFnU3RhcnQ6IGFueTtcbiAgaXNEcmFnZ2luZzogYm9vbGVhbjtcbiAgZHJhZ0VuZDogYW55O1xuXG4gIHByaXZhdGUgX2lzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgY29uc3QgY3VycmVudFllYXIgPSB0aGlzLmluaXREYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgY29uc3QgY3VycmVudE1vbnRoID0gdGhpcy5pbml0RGF0ZS5nZXRNb250aCgpO1xuICAgIHRoaXMuY3JlYXRlTW9udGhWaWV3KGN1cnJlbnRZZWFyLCBjdXJyZW50TW9udGgpO1xuXG4gICAgdGhpcy5faXNJbml0aWFsaXplZCA9IHRydWU7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5hbGxDZWxscyA9IHRoaXMuZGF5cy50b0FycmF5KCkubWFwKChlbDogRWxlbWVudFJlZikgPT4gZWwubmF0aXZlRWxlbWVudCk7XG4gIH1cblxuICB0cmFja0J5Rm4oaW5kZXgpIHtcbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICB0cmFja0J5RXZlbnQoaW5kZXgsIGl0ZW0pIHtcbiAgICByZXR1cm4gaXRlbS5pZDtcbiAgfVxuXG4gIHRyYWNrQnlEYXkoaW5kZXgsIGl0ZW0pIHtcbiAgICByZXR1cm4gaXRlbS5kYXlOdW1iZXI7XG4gIH1cblxuICBvbk1vdXNlRG93bihldmVudDogYW55LCBkYXk6IGFueSkge1xuICAgIHRoaXMuZHJhZ1N0YXJ0ID0gdGhpcy5hbGxDZWxscy5pbmRleE9mKGV2ZW50LnRhcmdldCk7XG4gICAgdGhpcy5pc0RyYWdnaW5nID0gdHJ1ZTtcbiAgICB0aGlzLnNlbGVjdGlvblN0YXJ0RGF0ZSA9IGRheS5zdGFydE9mRGF5O1xuICB9XG5cbiAgb25Nb3VzZVVwKGV2ZW50OiBhbnksIGRheTogYW55KSB7XG4gICAgdGhpcy5kcmFnRW5kID0gdGhpcy5hbGxDZWxscy5pbmRleE9mKGV2ZW50LnRhcmdldCk7XG4gICAgdGhpcy5zZWxlY3Rpb25FbmREYXRlID0gZGF5LmVuZE9mRGF5O1xuXG4gICAgY29uc3QgY2FsZW5kYXJFdmVudCA9IHtcbiAgICAgIG5hbWU6ICdOZXcgZXZlbnQnLFxuICAgICAgc3RhcnREYXRlOiB0aGlzLnNlbGVjdGlvblN0YXJ0RGF0ZSxcbiAgICAgIGVuZERhdGU6IHRoaXMuc2VsZWN0aW9uRW5kRGF0ZSxcbiAgICAgIGNvbG9yOiAnaW5mbycsXG4gICAgfTtcbiAgICBpZiAodGhpcy5kcmFnU3RhcnQgIT09IHRoaXMuZHJhZ0VuZCkge1xuICAgICAgdGhpcy5kYXlDbGlja2VkLmVtaXQoY2FsZW5kYXJFdmVudCk7XG4gICAgfVxuICAgIHRoaXMuaXNEcmFnZ2luZyA9IGZhbHNlO1xuXG4gICAgaWYgKHRoaXMuZHJhZ0VuZCAhPT0gMCkge1xuICAgICAgdGhpcy5zZWxlY3RSYW5nZSgpO1xuICAgIH1cblxuICAgIHRoaXMuY2xlYXJTZWxlY3Rpb24oKTtcbiAgfVxuXG4gIHNlbGVjdFJhbmdlKCkge1xuICAgIHRoaXMuY2xlYXJTZWxlY3Rpb24oKTtcblxuICAgIGlmICh0aGlzLmRyYWdFbmQgPiB0aGlzLmRyYWdTdGFydCkge1xuICAgICAgaWYgKHRoaXMuZHJhZ0VuZCArIDEgPCB0aGlzLmRyYWdTdGFydCkge1xuICAgICAgICB0aGlzLmFsbENlbGxzXG4gICAgICAgICAgLnNsaWNlKHRoaXMuZHJhZ0VuZCwgdGhpcy5kcmFnU3RhcnQgKyAxKVxuICAgICAgICAgIC5mb3JFYWNoKChjZWxsKSA9PlxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShjZWxsLCAnYmFja2dyb3VuZC1jb2xvcicsICdyZ2JhKDY5LDgyLDExMCwuMyknKVxuICAgICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFsbENlbGxzXG4gICAgICAgICAgLnNsaWNlKHRoaXMuZHJhZ1N0YXJ0LCB0aGlzLmRyYWdFbmQgKyAxKVxuICAgICAgICAgIC5mb3JFYWNoKChjZWxsKSA9PlxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShjZWxsLCAnYmFja2dyb3VuZC1jb2xvcicsICdyZ2JhKDY5LDgyLDExMCwuMyknKVxuICAgICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2xlYXJTZWxlY3Rpb24oKSB7XG4gICAgdGhpcy5hbGxDZWxscy5mb3JFYWNoKChjZWxsKSA9PiB0aGlzLnJlbmRlcmVyLnJlbW92ZVN0eWxlKGNlbGwsICdiYWNrZ3JvdW5kLWNvbG9yJykpO1xuICB9XG5cbiAgb25Nb3VzZU1vdmUoZXZlbnQ6IGFueSkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKHRoaXMuaXNEcmFnZ2luZykge1xuICAgICAgdGhpcy5kcmFnRW5kID0gdGhpcy5hbGxDZWxscy5pbmRleE9mKGV2ZW50LnRhcmdldCk7XG4gICAgICB0aGlzLnNlbGVjdFJhbmdlKCk7XG4gICAgfVxuICB9XG5cbiAgb25EYXlDbGljayhkYXk6IGFueSkge1xuICAgIGNvbnN0IG5ld0V2ZW50ID0ge1xuICAgICAgbmFtZTogJ05ldyBldmVudCcsXG4gICAgICBzdGFydERhdGU6IGRheS5zdGFydE9mRGF5LFxuICAgICAgZW5kRGF0ZTogZGF5LmVuZE9mRGF5LFxuICAgICAgY29sb3I6ICdpbmZvJyxcbiAgICB9O1xuICAgIHRoaXMuZGF5Q2xpY2tlZC5lbWl0KG5ld0V2ZW50KTtcbiAgfVxuXG4gIG9uRXZlbnRDbGljayhldmVudDogQ2FsZW5kYXJFdmVudCkge1xuICAgIGNvbnN0IGV2ZW50Q29weSA9IHtcbiAgICAgIGlkOiBldmVudC5pZCxcbiAgICAgIG5hbWU6IGV2ZW50Lm5hbWUsXG4gICAgICBzdGFydERhdGU6IGZvcm1hdChldmVudC5zdGFydERhdGUsICdZWVlZLU1NLURELCBISDptbTpzcycpLFxuICAgICAgZW5kRGF0ZTogZm9ybWF0KGV2ZW50LmVuZERhdGUsICdZWVlZLU1NLURELCBISDptbTpzcycpLFxuICAgICAgY29sb3I6IGV2ZW50LmNvbG9yLFxuICAgIH07XG4gICAgdGhpcy5ldmVudENsaWNrZWQuZW1pdChldmVudENvcHkpO1xuICB9XG5cbiAgb25WaWV3Q2hhbmdlKHZpZXc6IHN0cmluZykge1xuICAgIHRoaXMudmlld0NoYW5nZWQuZW1pdCh2aWV3KTtcbiAgfVxuXG4gIG5leHQoKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRNb250aCA9PT0gMTEpIHtcbiAgICAgIHRoaXMuY3JlYXRlTW9udGhWaWV3KHRoaXMuc2VsZWN0ZWRZZWFyICsgMSwgMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlTW9udGhWaWV3KHRoaXMuc2VsZWN0ZWRZZWFyLCB0aGlzLnNlbGVjdGVkTW9udGggKyAxKTtcbiAgICB9XG5cbiAgICB0aGlzLm1vbnRoQ2hhbmdlZC5lbWl0KHtcbiAgICAgIGluZGV4OiB0aGlzLnNlbGVjdGVkTW9udGgsXG4gICAgICBtb250aDogdGhpcy5tb250aHNbdGhpcy5zZWxlY3RlZE1vbnRoXSxcbiAgICAgIHllYXI6IHRoaXMuc2VsZWN0ZWRZZWFyLFxuICAgIH0pO1xuICB9XG5cbiAgcHJldmlvdXMoKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRNb250aCA9PT0gMCkge1xuICAgICAgdGhpcy5jcmVhdGVNb250aFZpZXcodGhpcy5zZWxlY3RlZFllYXIgLSAxLCAxMSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlTW9udGhWaWV3KHRoaXMuc2VsZWN0ZWRZZWFyLCB0aGlzLnNlbGVjdGVkTW9udGggLSAxKTtcbiAgICB9XG5cbiAgICB0aGlzLm1vbnRoQ2hhbmdlZC5lbWl0KHtcbiAgICAgIGluZGV4OiB0aGlzLnNlbGVjdGVkTW9udGgsXG4gICAgICBtb250aDogdGhpcy5tb250aHNbdGhpcy5zZWxlY3RlZE1vbnRoXSxcbiAgICAgIHllYXI6IHRoaXMuc2VsZWN0ZWRZZWFyLFxuICAgIH0pO1xuICB9XG5cbiAgZ29Ub1RvZGF5KCkge1xuICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBjdXJyZW50WWVhciA9IHRvZGF5LmdldEZ1bGxZZWFyKCk7XG4gICAgY29uc3QgY3VycmVudE1vbnRoID0gdG9kYXkuZ2V0TW9udGgoKTtcbiAgICB0aGlzLmNyZWF0ZU1vbnRoVmlldyhjdXJyZW50WWVhciwgY3VycmVudE1vbnRoKTtcblxuICAgIHRoaXMubW9udGhDaGFuZ2VkLmVtaXQoe1xuICAgICAgaW5kZXg6IHRoaXMuc2VsZWN0ZWRNb250aCxcbiAgICAgIG5hbWU6IHRoaXMubW9udGhzW3RoaXMuc2VsZWN0ZWRNb250aF0sXG4gICAgICB5ZWFyOiB0aGlzLnNlbGVjdGVkWWVhcixcbiAgICB9KTtcbiAgfVxuXG4gIGdldERheXNJblByZXZpb3VzTW9udGgoeWVhcjogbnVtYmVyLCBtb250aDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBpZiAobW9udGggPT09IC0xKSB7XG4gICAgICByZXR1cm4gZ2V0RGF5c0luTW9udGgobmV3IERhdGUoeWVhciAtIDEsIDExKSk7XG4gICAgfVxuICAgIHJldHVybiBnZXREYXlzSW5Nb250aChuZXcgRGF0ZSh5ZWFyLCBtb250aCkpO1xuICB9XG5cbiAgY3JlYXRlTW9udGhWaWV3KHllYXI6IG51bWJlciwgbW9udGg6IG51bWJlcikge1xuICAgIHRoaXMuc2VsZWN0ZWRNb250aCA9IG1vbnRoO1xuICAgIHRoaXMuc2VsZWN0ZWRZZWFyID0geWVhcjtcbiAgICBjb25zdCBkYXlzSW5Nb250aCA9IGdldERheXNJbk1vbnRoKG5ldyBEYXRlKHllYXIsIG1vbnRoKSk7XG4gICAgY29uc3QgZGF5c0luUHJldmlvdXNNb250aCA9IHRoaXMuZ2V0RGF5c0luUHJldmlvdXNNb250aCh5ZWFyLCBtb250aCAtIDEpO1xuICAgIGNvbnN0IGZpcnN0RGF5ID0gc3RhcnRPZldlZWsobmV3IERhdGUoeWVhciwgbW9udGgpLCB7IHdlZWtTdGFydHNPbjogdGhpcy53ZWVrRGF5SW5kZXggfSk7XG4gICAgY29uc3QgZmlyc3RWaXNpYmxlRGF5ID0gZ2V0RGF0ZShmaXJzdERheSk7XG5cbiAgICBsZXQgZGF5U3RhcnQ6IERhdGU7XG4gICAgbGV0IGRheUVuZDogRGF0ZTtcblxuICAgIGNvbnN0IGRhdGVzID0gW107XG4gICAgbGV0IGRheU51bWJlciA9IDE7XG4gICAgbGV0IG1vbnRoTnVtYmVyID0gbW9udGg7XG5cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IDc7IGkrKykge1xuICAgICAgY29uc3Qgd2VlayA9IFtdO1xuXG4gICAgICBpZiAoaSA9PT0gMSAmJiBmaXJzdFZpc2libGVEYXkgIT09IDEpIHtcbiAgICAgICAgZm9yIChsZXQgaiA9IGZpcnN0VmlzaWJsZURheTsgaiA8PSBkYXlzSW5QcmV2aW91c01vbnRoOyBqKyspIHtcbiAgICAgICAgICBkYXlTdGFydCA9IHN0YXJ0T2ZEYXkobmV3IERhdGUoeWVhciwgbW9udGggLSAxLCBqKSk7XG4gICAgICAgICAgZGF5RW5kID0gZW5kT2ZEYXkobmV3IERhdGUoeWVhciwgbW9udGggLSAxLCBqKSk7XG4gICAgICAgICAgd2Vlay5wdXNoKHtcbiAgICAgICAgICAgIGRheU51bWJlcjogaixcbiAgICAgICAgICAgIGlzVG9kYXk6IGZhbHNlLFxuICAgICAgICAgICAgaXNXZWVrZW5kOiBpc1dlZWtlbmQobmV3IERhdGUoeWVhciwgbW9udGggLSAxLCBqKSksXG4gICAgICAgICAgICBtb250aDogbW9udGggLSAxLFxuICAgICAgICAgICAgc3RhcnRPZkRheTogc3RhcnRPZkRheShuZXcgRGF0ZSh5ZWFyLCBtb250aCAtIDEsIGopKSxcbiAgICAgICAgICAgIGVuZE9mRGF5OiBlbmRPZkRheShuZXcgRGF0ZSh5ZWFyLCBtb250aCAtIDEsIGopKSxcbiAgICAgICAgICAgIGV2ZW50czogZ2V0TW9udGhEYXlFdmVudHModGhpcy5ldmVudHMsIGRheVN0YXJ0LCBkYXlFbmQpLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF5c0xlZnQgPSA3IC0gd2Vlay5sZW5ndGg7XG5cbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBkYXlzTGVmdDsgaisrKSB7XG4gICAgICAgICAgZGF5U3RhcnQgPSBzdGFydE9mRGF5KG5ldyBEYXRlKHllYXIsIG1vbnRoLCBkYXlOdW1iZXIpKTtcbiAgICAgICAgICBkYXlFbmQgPSBlbmRPZkRheShuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5TnVtYmVyKSk7XG5cbiAgICAgICAgICB3ZWVrLnB1c2goe1xuICAgICAgICAgICAgZGF5TnVtYmVyOiBkYXlOdW1iZXIsXG4gICAgICAgICAgICBpc1RvZGF5OiBpc1RvZGF5KG5ldyBEYXRlKHllYXIsIG1vbnRoLCBkYXlOdW1iZXIpKSxcbiAgICAgICAgICAgIGlzV2Vla2VuZDogaXNXZWVrZW5kKG5ldyBEYXRlKHllYXIsIG1vbnRoLCBkYXlOdW1iZXIpKSxcbiAgICAgICAgICAgIG1vbnRoOiBtb250aCxcbiAgICAgICAgICAgIHN0YXJ0T2ZEYXk6IHN0YXJ0T2ZEYXkobmV3IERhdGUoeWVhciwgbW9udGgsIGRheU51bWJlcikpLFxuICAgICAgICAgICAgZW5kT2ZEYXk6IGVuZE9mRGF5KG5ldyBEYXRlKHllYXIsIG1vbnRoLCBkYXlOdW1iZXIpKSxcbiAgICAgICAgICAgIGV2ZW50czogZ2V0TW9udGhEYXlFdmVudHModGhpcy5ldmVudHMsIGRheVN0YXJ0LCBkYXlFbmQpLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGRheU51bWJlcisrO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKGxldCBqID0gMTsgaiA8IDg7IGorKykge1xuICAgICAgICAgIGlmIChkYXlOdW1iZXIgPiBkYXlzSW5Nb250aCkge1xuICAgICAgICAgICAgZGF5TnVtYmVyID0gMTtcbiAgICAgICAgICAgIG1vbnRoTnVtYmVyID0gbW9udGggKyAxO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGRheVN0YXJ0ID0gc3RhcnRPZkRheShuZXcgRGF0ZSh5ZWFyLCBtb250aE51bWJlciwgZGF5TnVtYmVyKSk7XG4gICAgICAgICAgZGF5RW5kID0gZW5kT2ZEYXkobmV3IERhdGUoeWVhciwgbW9udGhOdW1iZXIsIGRheU51bWJlcikpO1xuXG4gICAgICAgICAgd2Vlay5wdXNoKHtcbiAgICAgICAgICAgIGRheU51bWJlcjogZGF5TnVtYmVyLFxuICAgICAgICAgICAgaXNUb2RheTogaXNUb2RheShuZXcgRGF0ZSh5ZWFyLCBtb250aE51bWJlciwgZGF5TnVtYmVyKSksXG4gICAgICAgICAgICBpc1dlZWtlbmQ6IGlzV2Vla2VuZChuZXcgRGF0ZSh5ZWFyLCBtb250aE51bWJlciwgZGF5TnVtYmVyKSksXG4gICAgICAgICAgICBtb250aDogbW9udGhOdW1iZXIsXG4gICAgICAgICAgICBzdGFydE9mRGF5OiBzdGFydE9mRGF5KG5ldyBEYXRlKHllYXIsIG1vbnRoTnVtYmVyLCBkYXlOdW1iZXIpKSxcbiAgICAgICAgICAgIGVuZE9mRGF5OiBlbmRPZkRheShuZXcgRGF0ZSh5ZWFyLCBtb250aE51bWJlciwgZGF5TnVtYmVyKSksXG4gICAgICAgICAgICBldmVudHM6IGdldE1vbnRoRGF5RXZlbnRzKHRoaXMuZXZlbnRzLCBkYXlTdGFydCwgZGF5RW5kKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBkYXlOdW1iZXIrKztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZGF0ZXMucHVzaCh7IHdlZWsgfSk7XG4gICAgfVxuICAgIHRoaXMuZGF0ZXMgPSBkYXRlcztcbiAgfVxufVxuIl19