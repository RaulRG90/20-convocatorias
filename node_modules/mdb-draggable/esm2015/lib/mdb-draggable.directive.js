import { Directive, ElementRef, HostBinding, Renderer2, Input, Inject, EventEmitter, Output } from '@angular/core';
import { fromEvent, merge, Subject } from 'rxjs';
import { takeUntil, tap, first, concatMap, filter } from 'rxjs/operators';
import { DOCUMENT } from "@angular/common";
export class MdbDraggableDirective {
    constructor(el, renderer, document) {
        this.el = el;
        this.renderer = renderer;
        this.document = document;
        this.disabled = false;
        this.resetPosition = false;
        this.snapSensitivity = 50;
        this.lockAxis = null;
        this.autoScroll = true;
        this.scrollSpeed = 25;
        this.scrollSensitivity = 30;
        this.snapToGrid = false;
        this.gridSize = 1;
        this.dragStart = new EventEmitter();
        this.dragEnd = new EventEmitter();
        this.elPos = { x: 0, y: 0 };
        this.draggableEl = this.el.nativeElement;
        this.destroy$ = new Subject();
        this.movable = true;
        this.dragging = false;
    }
    get boundTo() { return this._boundTo; }
    set boundTo(value) {
        if (typeof value === 'string') {
            this._boundTo = this.getHtmlElement(value);
        }
        else {
            this._boundTo = value;
        }
    }
    get handle() { return this._handle; }
    set handle(value) {
        if (typeof value === 'string') {
            this._handle = this.getHtmlElement(value);
            this.draggableEl = this.getHtmlElement(value);
        }
        else {
            this._handle = value;
            this.draggableEl = value;
        }
    }
    _subscribeToEvents() {
        const drag = this.start$
            .pipe(filter((event) => event.button !== 2), concatMap((event) => {
            this.onDragStart(event);
            return this.move$
                .pipe(tap((moveEvent) => {
                this.onDragMove(moveEvent);
            }), takeUntil(this.end$));
        }), takeUntil(this.destroy$));
        const drop = this.start$
            .pipe(concatMap(() => {
            return this.end$
                .pipe(first(), tap(() => {
                this.onDragEnd();
            }));
        }), takeUntil(this.destroy$));
        drag.subscribe();
        drop.subscribe();
    }
    ngOnInit() {
        this.start$ = merge(fromEvent(this.draggableEl, 'mousedown', { passive: false }), fromEvent(this.draggableEl, 'touchstart', { passive: false }));
        this.move$ = merge(fromEvent(this.document, 'mousemove', { passive: false }), fromEvent(this.document, 'touchmove', { passive: false }));
        this.end$ = merge(fromEvent(this.document, 'mouseup', { passive: false }), fromEvent(this.document, 'touchend', { passive: false }));
        this._subscribeToEvents();
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    _resetPos() {
        this.elPos.x = 0;
        this.elPos.y = 0;
        this.renderer.setStyle(this.el.nativeElement, 'transition', 'transform ease .5s');
        this._updatePosition();
    }
    getHtmlElement(selector) {
        return this.document.querySelector(selector);
    }
    _measureBoundaries() {
        const viewRect = this.boundTo.getBoundingClientRect();
        const movableClientRect = this.el.nativeElement.getBoundingClientRect();
        this.boundaries = {
            minX: viewRect.left - movableClientRect.left + this.elPos.x,
            maxX: viewRect.right - movableClientRect.right + this.elPos.x,
            minY: viewRect.top - movableClientRect.top + this.elPos.y,
            maxY: viewRect.bottom - movableClientRect.bottom + this.elPos.y
        };
    }
    _applyBoundaries() {
        this.elPos.x = Math.max(this.boundaries.minX, this.elPos.x);
        this.elPos.x = Math.min(this.boundaries.maxX, this.elPos.x);
        this.elPos.y = Math.max(this.boundaries.minY, this.elPos.y);
        this.elPos.y = Math.min(this.boundaries.maxY, this.elPos.y);
    }
    onDragStart(event) {
        event.preventDefault();
        if (event instanceof MouseEvent && event.button === 2) {
            return;
        }
        if (this.resetPosition) {
            this.renderer.removeStyle(this.el.nativeElement, 'transition');
        }
        this.dragging = true;
        if (event.type === 'mousedown') {
            this.startPos = {
                x: event.pageX - this.elPos.x,
                y: event.pageY - this.elPos.y
            };
        }
        else {
            this.startPos = {
                x: event.changedTouches[0].pageX - this.elPos.x,
                y: event.changedTouches[0].pageY - this.elPos.y
            };
        }
        if (this.boundTo) {
            this._measureBoundaries();
        }
        this.dragStart.emit(this.el.nativeElement);
    }
    _updateScrollPos() {
        const elRect = this.el.nativeElement.getBoundingClientRect();
        const height = this.document.documentElement.clientHeight;
        const width = this.document.documentElement.clientWidth;
        if (elRect.top < this.scrollSensitivity) {
            this.document.documentElement.scrollTop -= this.scrollSpeed;
        }
        if (elRect.top + elRect.height > height - this.scrollSensitivity) {
            this.document.documentElement.scrollTop += this.scrollSpeed;
        }
        if (elRect.left < this.scrollSensitivity) {
            this.document.documentElement.scrollLeft -= this.scrollSpeed;
        }
        if (elRect.left + elRect.width > width - this.scrollSensitivity) {
            this.document.documentElement.scrollLeft += this.scrollSpeed;
        }
    }
    onDragMove(event) {
        event.preventDefault();
        if (this.disabled) {
            return;
        }
        if (this.snapToGrid && this.gridSize > 1) {
            if (event.type === 'mousemove') {
                this.elPos.x = Math.round((event.pageX - this.startPos.x) / this.gridSize) * this.gridSize;
                this.elPos.y = Math.round((event.pageY - this.startPos.y) / this.gridSize) * this.gridSize;
            }
            else {
                this.elPos.x = Math.round((event.changedTouches[0].pageX - this.startPos.x) / this.gridSize) * this.gridSize;
                this.elPos.y = Math.round((event.changedTouches[0].pageY - this.startPos.y) / this.gridSize) * this.gridSize;
            }
        }
        else {
            if (event.type === 'mousemove') {
                this.elPos.x = event.pageX - this.startPos.x;
                this.elPos.y = event.pageY - this.startPos.y;
            }
            else {
                this.elPos.x = event.changedTouches[0].pageX - this.startPos.x;
                this.elPos.y = event.changedTouches[0].pageY - this.startPos.y;
            }
        }
        if (this.boundTo) {
            this._applyBoundaries();
        }
        if (this.lockAxis === 'x') {
            this.elPos.y = 0;
        }
        if (this.lockAxis === 'y') {
            this.elPos.x = 0;
        }
        if (this.autoScroll) {
            this._updateScrollPos();
        }
        this._updatePosition();
    }
    onDragEnd() {
        this.dragging = false;
        if (this.resetPosition) {
            this._resetPos();
        }
        this.dragEnd.emit(this.el.nativeElement);
    }
    _updatePosition() {
        requestAnimationFrame(() => {
            const position = `translate(${this.elPos.x}px, ${this.elPos.y}px)`;
            this.renderer.setStyle(this.el.nativeElement, 'transform', position);
        });
    }
}
MdbDraggableDirective.decorators = [
    { type: Directive, args: [{
                selector: '[mdbDraggable]'
            },] }
];
MdbDraggableDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
MdbDraggableDirective.propDecorators = {
    disabled: [{ type: Input }],
    resetPosition: [{ type: Input }],
    boundTo: [{ type: Input }],
    handle: [{ type: Input }],
    snapSensitivity: [{ type: Input }],
    lockAxis: [{ type: Input }],
    autoScroll: [{ type: Input }],
    scrollSpeed: [{ type: Input }],
    scrollSensitivity: [{ type: Input }],
    snapToGrid: [{ type: Input }],
    gridSize: [{ type: Input }],
    dragStart: [{ type: Output }],
    dragEnd: [{ type: Output }],
    movable: [{ type: HostBinding, args: ['class.mdb-draggable',] }],
    dragging: [{ type: HostBinding, args: ['class.mdb-dragging',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLWRyYWdnYWJsZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9tZGItZHJhZ2dhYmxlL3NyYy9saWIvbWRiLWRyYWdnYWJsZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsV0FBVyxFQUNYLFNBQVMsRUFHVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixNQUFNLEVBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBTzNDLE1BQU0sT0FBTyxxQkFBcUI7SUFzRGhDLFlBQ1UsRUFBYyxFQUNkLFFBQW1CLEVBQ0QsUUFBYTtRQUYvQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2QsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNELGFBQVEsR0FBUixRQUFRLENBQUs7UUF4RGhDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUF3QnRCLG9CQUFlLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLGFBQVEsR0FBVyxJQUFJLENBQUM7UUFDeEIsZUFBVSxHQUFHLElBQUksQ0FBQztRQUNsQixnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixzQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDdkIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNuQixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBRVosY0FBUyxHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUFDNUMsWUFBTyxHQUFHLElB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SUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxFQUFFO1lBQ3hDLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7Z0JBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQzNGLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7YUFDNUY7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQzdHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO2FBQzlHO1NBQ0Y7YUFBTTtZQUNMLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7Z0JBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQzdDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7YUFDOUM7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQy9ELElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2FBQ2hFO1NBQ0Y7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7U0FDekI7UUFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssR0FBRyxFQUFFO1lBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNsQjtRQUVELElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxHQUFHLEVBQUU7WUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2xCO1FBRUQsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQ3pCO1FBRUQsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFRCxTQUFTO1FBQ1AsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFFdEIsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNsQjtRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVPLGVBQWU7UUFDckIscUJBQXFCLENBQUMsR0FBRyxFQUFFO1lBQ3pCLE1BQU0sUUFBUSxHQUFHLGFBQWEsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNuRSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdkUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7WUFsUkYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxnQkFBZ0I7YUFDM0I7OztZQWxCQyxVQUFVO1lBRVYsU0FBUzs0Q0EwRU4sTUFBTSxTQUFDLFFBQVE7Ozt1QkF4RGpCLEtBQUs7NEJBQ0wsS0FBSztzQkFDTCxLQUFLO3FCQVVMLEtBQUs7OEJBYUwsS0FBSzt1QkFDTCxLQUFLO3lCQUNMLEtBQUs7MEJBQ0wsS0FBSztnQ0FDTCxLQUFLO3lCQUNMLEtBQUs7dUJBQ0wsS0FBSzt3QkFFTCxNQUFNO3NCQUNOLE1BQU07c0JBd0JOLFdBQVcsU0FBQyxxQkFBcUI7dUJBR2pDLFdBQVcsU0FBQyxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBSZW5kZXJlcjIsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95LFxuICBJbnB1dCxcbiAgSW5qZWN0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgbWVyZ2UsIFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCwgdGFwLCBmaXJzdCwgY29uY2F0TWFwLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gXCJAYW5ndWxhci9jb21tb25cIjtcbmltcG9ydCB7IFBvc2l0aW9uIH0gZnJvbSAnLi9wb3NpdGlvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQm91bmRhcmllcyB9IGZyb20gJy4vYm91bmRhcmllcy5pbnRlcmZhY2UnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbWRiRHJhZ2dhYmxlXSdcbn0pXG5leHBvcnQgY2xhc3MgTWRiRHJhZ2dhYmxlRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xuICBASW5wdXQoKSByZXNldFBvc2l0aW9uID0gZmFsc2U7XG4gIEBJbnB1dCgpXG4gIGdldCBib3VuZFRvKCkgeyByZXR1cm4gdGhpcy5fYm91bmRUbzsgfVxuICBzZXQgYm91bmRUbyh2YWx1ZTogYW55KSB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRoaXMuX2JvdW5kVG8gPSB0aGlzLmdldEh0bWxFbGVtZW50KHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fYm91bmRUbyA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIF9ib3VuZFRvOiBIVE1MRWxlbWVudDtcbiAgQElucHV0KClcbiAgZ2V0IGhhbmRsZSgpIHsgcmV0dXJuIHRoaXMuX2hhbmRsZTsgfVxuICBzZXQgaGFuZGxlKHZhbHVlOiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5faGFuZGxlID0gdGhpcy5nZXRIdG1sRWxlbWVudCh2YWx1ZSk7XG4gICAgICB0aGlzLmRyYWdnYWJsZUVsID0gdGhpcy5nZXRIdG1sRWxlbWVudCh2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2hhbmRsZSA9IHZhbHVlO1xuICAgICAgdGhpcy5kcmFnZ2FibGVFbCA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIF9oYW5kbGU6IEhUTUxFbGVtZW50O1xuXG4gIEBJbnB1dCgpIHNuYXBTZW5zaXRpdml0eSA9IDUwO1xuICBASW5wdXQoKSBsb2NrQXhpczogc3RyaW5nID0gbnVsbDtcbiAgQElucHV0KCkgYXV0b1Njcm9sbCA9IHRydWU7XG4gIEBJbnB1dCgpIHNjcm9sbFNwZWVkID0gMjU7XG4gIEBJbnB1dCgpIHNjcm9sbFNlbnNpdGl2aXR5ID0gMzA7XG4gIEBJbnB1dCgpIHNuYXBUb0dyaWQgPSBmYWxzZTtcbiAgQElucHV0KCkgZ3JpZFNpemUgPSAxO1xuXG4gIEBPdXRwdXQoKSBkcmFnU3RhcnQgPSBuZXcgRXZlbnRFbWl0dGVyPEhUTUxFbGVtZW50PigpO1xuICBAT3V0cHV0KCkgZHJhZ0VuZCA9IG5ldyBFdmVudEVtaXR0ZXI8SFRNTEVsZW1lbnQ+KCk7XG5cbiAgcHJpdmF0ZSBlbFBvczogUG9zaXRpb24gPSB7IHg6IDAsIHk6IDAgfTtcblxuICBwcml2YXRlIHN0YXJ0UG9zOiBQb3NpdGlvbjtcblxuICBwcml2YXRlIGJvdW5kYXJpZXM6IEJvdW5kYXJpZXM7XG5cbiAgcHJpdmF0ZSBkcmFnZ2FibGVFbDogSFRNTEVsZW1lbnQgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgb2Zmc2V0WDogTnVtYmVyO1xuICBvZmZzZXRZOiBOdW1iZXI7XG5cbiAgc3RhcnQkOiBPYnNlcnZhYmxlPGFueT47XG4gIG1vdmUkOiBPYnNlcnZhYmxlPGFueT47XG4gIGVuZCQ6IE9ic2VydmFibGU8YW55PjtcblxuICBwcml2YXRlIGRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQ6IGFueSkge31cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLm1kYi1kcmFnZ2FibGUnKVxuICBtb3ZhYmxlID0gdHJ1ZTtcblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLm1kYi1kcmFnZ2luZycpXG4gIGRyYWdnaW5nID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBfc3Vic2NyaWJlVG9FdmVudHMoKSB7XG4gICAgY29uc3QgZHJhZyA9IHRoaXMuc3RhcnQkXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKCAoZXZlbnQ6IGFueSkgPT4gZXZlbnQuYnV0dG9uICE9PSAyICksXG4gICAgICAgIGNvbmNhdE1hcCggKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLm9uRHJhZ1N0YXJ0KGV2ZW50KTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5tb3ZlJFxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIHRhcCggKG1vdmVFdmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyYWdNb3ZlKG1vdmVFdmVudCk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICB0YWtlVW50aWwodGhpcy5lbmQkKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKVxuICAgICAgKTtcblxuICAgICAgY29uc3QgZHJvcCA9IHRoaXMuc3RhcnQkXG4gICAgICAucGlwZShcbiAgICAgICAgY29uY2F0TWFwKCAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZW5kJFxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIGZpcnN0KCksXG4gICAgICAgICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyYWdFbmQoKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JClcbiAgICAgICk7XG5cbiAgICAgIGRyYWcuc3Vic2NyaWJlKCk7XG4gICAgICBkcm9wLnN1YnNjcmliZSgpO1xuXG4gIH1cblxuICBuZ09uSW5pdCgpIHtcblxuICAgIHRoaXMuc3RhcnQkID0gbWVyZ2UoXG4gICAgICBmcm9tRXZlbnQodGhpcy5kcmFnZ2FibGVFbCwgJ21vdXNlZG93bicsIHsgcGFzc2l2ZTogZmFsc2UgfSksXG4gICAgICBmcm9tRXZlbnQodGhpcy5kcmFnZ2FibGVFbCwgJ3RvdWNoc3RhcnQnLCB7IHBhc3NpdmU6IGZhbHNlIH0pXG4gICAgKTtcblxuICAgIHRoaXMubW92ZSQgPSBtZXJnZShcbiAgICAgIGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2Vtb3ZlJywgeyBwYXNzaXZlOiBmYWxzZSB9KSxcbiAgICAgIGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAndG91Y2htb3ZlJywgeyBwYXNzaXZlOiBmYWxzZSB9KVxuICAgICk7XG5cbiAgICB0aGlzLmVuZCQgPSBtZXJnZShcbiAgICAgIGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2V1cCcsIHsgcGFzc2l2ZTogZmFsc2UgfSksXG4gICAgICBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ3RvdWNoZW5kJywgeyBwYXNzaXZlOiBmYWxzZSB9KSxcbiAgICApO1xuXG4gICAgdGhpcy5fc3Vic2NyaWJlVG9FdmVudHMoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xuICAgIHRoaXMuZGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Jlc2V0UG9zKCkge1xuICAgIHRoaXMuZWxQb3MueCA9IDA7XG4gICAgdGhpcy5lbFBvcy55ID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ3RyYW5zaXRpb24nLCAndHJhbnNmb3JtIGVhc2UgLjVzJyk7XG5cbiAgICB0aGlzLl91cGRhdGVQb3NpdGlvbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIdG1sRWxlbWVudChzZWxlY3Rvcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XG4gIH1cblxuICBwcml2YXRlIF9tZWFzdXJlQm91bmRhcmllcygpIHtcbiAgICBjb25zdCB2aWV3UmVjdDogQ2xpZW50UmVjdCA9IHRoaXMuYm91bmRUby5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBtb3ZhYmxlQ2xpZW50UmVjdDogQ2xpZW50UmVjdCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgIHRoaXMuYm91bmRhcmllcyA9IHtcbiAgICAgIG1pblg6IHZpZXdSZWN0LmxlZnQgLSBtb3ZhYmxlQ2xpZW50UmVjdC5sZWZ0ICsgdGhpcy5lbFBvcy54LFxuICAgICAgbWF4WDogdmlld1JlY3QucmlnaHQgLSBtb3ZhYmxlQ2xpZW50UmVjdC5yaWdodCArIHRoaXMuZWxQb3MueCxcbiAgICAgIG1pblk6IHZpZXdSZWN0LnRvcCAtIG1vdmFibGVDbGllbnRSZWN0LnRvcCArIHRoaXMuZWxQb3MueSxcbiAgICAgIG1heFk6IHZpZXdSZWN0LmJvdHRvbSAtIG1vdmFibGVDbGllbnRSZWN0LmJvdHRvbSArIHRoaXMuZWxQb3MueVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIF9hcHBseUJvdW5kYXJpZXMoKSB7XG4gICAgdGhpcy5lbFBvcy54ID0gTWF0aC5tYXgodGhpcy5ib3VuZGFyaWVzLm1pblgsIHRoaXMuZWxQb3MueCk7XG4gICAgdGhpcy5lbFBvcy54ID0gTWF0aC5taW4odGhpcy5ib3VuZGFyaWVzLm1heFgsIHRoaXMuZWxQb3MueCk7XG4gICAgdGhpcy5lbFBvcy55ID0gTWF0aC5tYXgodGhpcy5ib3VuZGFyaWVzLm1pblksIHRoaXMuZWxQb3MueSk7XG4gICAgdGhpcy5lbFBvcy55ID0gTWF0aC5taW4odGhpcy5ib3VuZGFyaWVzLm1heFksIHRoaXMuZWxQb3MueSk7XG4gIH1cblxuICBvbkRyYWdTdGFydChldmVudDogYW55KSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBNb3VzZUV2ZW50ICYmIGV2ZW50LmJ1dHRvbiA9PT0gMikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc2V0UG9zaXRpb24pIHtcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlU3R5bGUodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAndHJhbnNpdGlvbicpO1xuICAgIH1cblxuICAgIHRoaXMuZHJhZ2dpbmcgPSB0cnVlO1xuXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09ICdtb3VzZWRvd24nKSB7XG4gICAgICB0aGlzLnN0YXJ0UG9zID0ge1xuICAgICAgICB4OiBldmVudC5wYWdlWCAtIHRoaXMuZWxQb3MueCxcbiAgICAgICAgeTogZXZlbnQucGFnZVkgLSB0aGlzLmVsUG9zLnlcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3RhcnRQb3MgPSB7XG4gICAgICAgIHg6IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIC0gdGhpcy5lbFBvcy54LFxuICAgICAgICB5OiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWSAtIHRoaXMuZWxQb3MueVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5ib3VuZFRvKSB7XG4gICAgICB0aGlzLl9tZWFzdXJlQm91bmRhcmllcygpO1xuICAgIH1cblxuICAgIHRoaXMuZHJhZ1N0YXJ0LmVtaXQodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcblxuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlU2Nyb2xsUG9zKCkge1xuICAgIGNvbnN0IGVsUmVjdCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDtcbiAgICBjb25zdCB3aWR0aCA9IHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoO1xuXG5cbiAgICBpZiAoZWxSZWN0LnRvcCA8IHRoaXMuc2Nyb2xsU2Vuc2l0aXZpdHkpIHtcbiAgICAgIHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCAtPSB0aGlzLnNjcm9sbFNwZWVkO1xuICAgIH1cblxuICAgIGlmIChlbFJlY3QudG9wICsgZWxSZWN0LmhlaWdodCA+IGhlaWdodCAtIHRoaXMuc2Nyb2xsU2Vuc2l0aXZpdHkpIHtcbiAgICAgIHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCArPSB0aGlzLnNjcm9sbFNwZWVkO1xuICAgIH1cblxuICAgIGlmIChlbFJlY3QubGVmdCAgPCB0aGlzLnNjcm9sbFNlbnNpdGl2aXR5KSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0IC09IHRoaXMuc2Nyb2xsU3BlZWQ7XG4gICAgfVxuXG4gICAgaWYgKGVsUmVjdC5sZWZ0ICsgZWxSZWN0LndpZHRoID4gd2lkdGggLSB0aGlzLnNjcm9sbFNlbnNpdGl2aXR5KSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0ICs9IHRoaXMuc2Nyb2xsU3BlZWQ7XG4gICAgfVxuICB9XG5cbiAgb25EcmFnTW92ZShldmVudDogYW55KSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNuYXBUb0dyaWQgJiYgdGhpcy5ncmlkU2l6ZSA+IDEpIHtcbiAgICAgIGlmIChldmVudC50eXBlID09PSAnbW91c2Vtb3ZlJykge1xuICAgICAgICB0aGlzLmVsUG9zLnggPSBNYXRoLnJvdW5kKChldmVudC5wYWdlWCAtIHRoaXMuc3RhcnRQb3MueCkgLyB0aGlzLmdyaWRTaXplKSAqIHRoaXMuZ3JpZFNpemU7XG4gICAgICAgIHRoaXMuZWxQb3MueSA9IE1hdGgucm91bmQoKGV2ZW50LnBhZ2VZIC0gdGhpcy5zdGFydFBvcy55KSAvIHRoaXMuZ3JpZFNpemUpICogdGhpcy5ncmlkU2l6ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZWxQb3MueCA9IE1hdGgucm91bmQoKGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIC0gdGhpcy5zdGFydFBvcy54KSAvIHRoaXMuZ3JpZFNpemUpICogdGhpcy5ncmlkU2l6ZTtcbiAgICAgICAgdGhpcy5lbFBvcy55ID0gTWF0aC5yb3VuZCgoZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVkgLSB0aGlzLnN0YXJ0UG9zLnkpIC8gdGhpcy5ncmlkU2l6ZSkgKiB0aGlzLmdyaWRTaXplO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ21vdXNlbW92ZScpIHtcbiAgICAgICAgdGhpcy5lbFBvcy54ID0gZXZlbnQucGFnZVggLSB0aGlzLnN0YXJ0UG9zLng7XG4gICAgICAgIHRoaXMuZWxQb3MueSA9IGV2ZW50LnBhZ2VZIC0gdGhpcy5zdGFydFBvcy55O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbFBvcy54ID0gZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVggLSB0aGlzLnN0YXJ0UG9zLng7XG4gICAgICAgIHRoaXMuZWxQb3MueSA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZIC0gdGhpcy5zdGFydFBvcy55O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmJvdW5kVG8pIHtcbiAgICAgIHRoaXMuX2FwcGx5Qm91bmRhcmllcygpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmxvY2tBeGlzID09PSAneCcpIHtcbiAgICAgIHRoaXMuZWxQb3MueSA9IDA7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubG9ja0F4aXMgPT09ICd5Jykge1xuICAgICAgdGhpcy5lbFBvcy54ID0gMDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hdXRvU2Nyb2xsKSB7XG4gICAgICB0aGlzLl91cGRhdGVTY3JvbGxQb3MoKTtcbiAgICB9XG5cbiAgICB0aGlzLl91cGRhdGVQb3NpdGlvbigpO1xuICB9XG5cbiAgb25EcmFnRW5kKCkge1xuICAgIHRoaXMuZHJhZ2dpbmcgPSBmYWxzZTtcblxuICAgIGlmICh0aGlzLnJlc2V0UG9zaXRpb24pIHtcbiAgICAgIHRoaXMuX3Jlc2V0UG9zKCk7XG4gICAgfVxuXG4gICAgdGhpcy5kcmFnRW5kLmVtaXQodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZVBvc2l0aW9uKCkge1xuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICBjb25zdCBwb3NpdGlvbiA9IGB0cmFuc2xhdGUoJHt0aGlzLmVsUG9zLnh9cHgsICR7dGhpcy5lbFBvcy55fXB4KWA7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ3RyYW5zZm9ybScsIHBvc2l0aW9uKTtcbiAgICB9KTtcbiAgfVxufVxuIl19