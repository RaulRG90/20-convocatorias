import { Directive, HostListener, Inject, Input, Renderer2 } from '@angular/core';
import { MdbFilterService } from "./mdb-filter.service";
import { DOCUMENT } from "@angular/common";
export class MdbFilterDirective {
    constructor(filterService, renderer, document) {
        this.filterService = filterService;
        this.renderer = renderer;
        this.document = document;
        this.mdbFilter = '';
        this.surroundingFilterItem = true;
        this.filters = { previousValue: '', currentValue: '' };
        this.animationClass = ['animated', 'zoomIn', 'faster'];
        this.filterService.previousCurrentFilterChange().subscribe((filters) => {
            this.filters = filters;
        });
    }
    ngAfterViewInit() {
        if (this.mdbFilter.length <= 0) {
            this.filterService.getItems().forEach((el) => {
                this.renderer.addClass(el, 'd-none');
            });
            this.onClick(new Event('click'));
        }
    }
    addAnimationClasses(el) {
        if (this.animationClass) {
            const elements = this.surroundingFilterItem ? [el, el.parentElement] : [el];
            elements.forEach((element) => {
                this.animationClass.forEach((className) => {
                    this.renderer.addClass(element, className);
                });
                this.renderer.removeClass(element, 'd-none');
            });
        }
    }
    removeAnimationClasses(el) {
        if (this.animationClass) {
            const elements = this.surroundingFilterItem ? [el, el.parentElement] : [el];
            elements.forEach((element) => {
                this.renderer.addClass(element, 'd-none');
                this.animationClass.forEach((className) => {
                    this.renderer.removeClass(element, className);
                });
            });
        }
    }
    _getClosestEl(el, selector) {
        for (; el && el !== this.document; el = el.parentNode) {
            if (el.matches(selector)) {
                return el;
            }
        }
        return null;
    }
    onClick(event) {
        if (this._getClosestEl(event.target, '.item') === null) {
            this.filterService.setFilter(this.mdbFilter);
            this.filterService.getItems().forEach((el) => {
                this.animationClass = el.getAttribute('data-animation-class').split(',');
                if (this.filters.previousValue === '' || this.filters.previousValue == 'undefined' || this.filters.previousValue == undefined || this.filters == undefined) {
                    if (el.getAttribute('data-filter-item') == this.filters.currentValue) {
                        this.removeAnimationClasses(el);
                        setTimeout(() => {
                            this.addAnimationClasses(el);
                        }, 15);
                    }
                }
                if (this.mdbFilter == '') {
                    if (el.getAttribute('data-filter-item') == this.filters.previousValue) {
                        this.removeAnimationClasses(el);
                        setTimeout(() => {
                            this.addAnimationClasses(el);
                        }, 15);
                    }
                    setTimeout(() => {
                        const elements = this.surroundingFilterItem ? [el, el.parentElement] : [el];
                        elements.forEach((element) => {
                            this.renderer.addClass(element, 'd-none');
                        });
                        this.addAnimationClasses(el);
                    }, 15);
                }
                else if (el.getAttribute('data-filter-item') !== this.mdbFilter) {
                    const elements = this.surroundingFilterItem ? [el, el.parentElement] : [el];
                    elements.forEach((element) => {
                        this.renderer.addClass(element, 'd-none');
                    });
                }
                else {
                    setTimeout(() => {
                        const elements = this.surroundingFilterItem ? [el, el.parentElement] : [el];
                        elements.forEach((element) => {
                            this.renderer.removeClass(element, 'd-none');
                        });
                    }, 15);
                }
            });
        }
    }
}
MdbFilterDirective.decorators = [
    { type: Directive, args: [{ selector: '[mdbFilter]' },] }
];
MdbFilterDirective.ctorParameters = () => [
    { type: MdbFilterService },
    { type: Renderer2 },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
MdbFilterDirective.propDecorators = {
    mdbFilter: [{ type: Input }],
    surroundingFilterItem: [{ type: Input }],
    onClick: [{ type: HostListener, args: ['click', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLWZpbHRlci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9tZGItZmlsdGVyL3NyYy9saWIvbWRiLWZpbHRlci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQ2xELE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ3RELE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUl6QyxNQUFNLE9BQU8sa0JBQWtCO0lBTzdCLFlBQ1UsYUFBK0IsRUFDL0IsUUFBbUIsRUFDRCxRQUFhO1FBRi9CLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQUMvQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ0QsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQVRoQyxjQUFTLEdBQVcsRUFBRSxDQUFDO1FBQ3ZCLDBCQUFxQixHQUFZLElBQUksQ0FBQztRQUUvQyxZQUFPLEdBQW9ELEVBQUMsYUFBYSxFQUFFLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFDLENBQUE7UUFDaEcsbUJBQWMsR0FBYSxDQUFDLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFNMUQsSUFBSSxDQUFDLGFBQWEsQ0FBQywyQkFBMkIsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQVksRUFBRSxFQUFFO1lBQzFFLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUM5QixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FB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QUFDLGtCQUFrQixDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsRUFBRTtvQkFDakUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQzVFLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFZLEVBQUUsRUFBRTt3QkFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUM1QyxDQUFDLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxVQUFVLENBQUMsR0FBRyxFQUFFO3dCQUNkLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3dCQUM1RSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBWSxFQUFFLEVBQUU7NEJBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFDL0MsQ0FBQyxDQUFDLENBQUM7b0JBQ0wsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2lCQUNSO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7OztZQXJHRixTQUFTLFNBQUMsRUFBQyxRQUFRLEVBQUUsYUFBYSxFQUFDOzs7WUFKNUIsZ0JBQWdCO1lBRmtCLFNBQVM7NENBaUI5QyxNQUFNLFNBQUMsUUFBUTs7O3dCQVRqQixLQUFLO29DQUNMLEtBQUs7c0JBd0RMLFlBQVksU0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBEaXJlY3RpdmUsIEhvc3RMaXN0ZW5lciwgSW5qZWN0LCBJbnB1dCwgUmVuZGVyZXIyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtNZGJGaWx0ZXJTZXJ2aWNlfSBmcm9tIFwiLi9tZGItZmlsdGVyLnNlcnZpY2VcIjtcbmltcG9ydCB7RE9DVU1FTlR9IGZyb20gXCJAYW5ndWxhci9jb21tb25cIjtcblxuXG5ARGlyZWN0aXZlKHtzZWxlY3RvcjogJ1ttZGJGaWx0ZXJdJ30pXG5leHBvcnQgY2xhc3MgTWRiRmlsdGVyRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCB7XG4gIEBJbnB1dCgpIG1kYkZpbHRlcjogc3RyaW5nID0gJyc7XG4gIEBJbnB1dCgpIHN1cnJvdW5kaW5nRmlsdGVySXRlbTogYm9vbGVhbiA9IHRydWU7XG5cbiAgZmlsdGVyczogeyBwcmV2aW91c1ZhbHVlOiBzdHJpbmcsIGN1cnJlbnRWYWx1ZTogc3RyaW5nIH0gPSB7cHJldmlvdXNWYWx1ZTogJycsIGN1cnJlbnRWYWx1ZTogJyd9XG4gIGFuaW1hdGlvbkNsYXNzOiBzdHJpbmdbXSA9IFsnYW5pbWF0ZWQnLCAnem9vbUluJywgJ2Zhc3RlciddO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZmlsdGVyU2VydmljZTogTWRiRmlsdGVyU2VydmljZSxcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogYW55KSB7XG4gICAgdGhpcy5maWx0ZXJTZXJ2aWNlLnByZXZpb3VzQ3VycmVudEZpbHRlckNoYW5nZSgpLnN1YnNjcmliZSgoZmlsdGVyczogYW55KSA9PiB7XG4gICAgICB0aGlzLmZpbHRlcnMgPSBmaWx0ZXJzO1xuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLm1kYkZpbHRlci5sZW5ndGggPD0gMCkge1xuICAgICAgdGhpcy5maWx0ZXJTZXJ2aWNlLmdldEl0ZW1zKCkuZm9yRWFjaCgoZWw6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKGVsLCAnZC1ub25lJyk7XG4gICAgICB9KVxuICAgICAgdGhpcy5vbkNsaWNrKG5ldyBFdmVudCgnY2xpY2snKSk7XG4gICAgfVxuICB9XG5cbiAgYWRkQW5pbWF0aW9uQ2xhc3NlcyhlbDogYW55KSB7XG4gICAgaWYgKHRoaXMuYW5pbWF0aW9uQ2xhc3MpIHtcbiAgICAgIGNvbnN0IGVsZW1lbnRzID0gdGhpcy5zdXJyb3VuZGluZ0ZpbHRlckl0ZW0gPyBbZWwsIGVsLnBhcmVudEVsZW1lbnRdIDogW2VsXTtcbiAgICAgIGVsZW1lbnRzLmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLmFuaW1hdGlvbkNsYXNzLmZvckVhY2goKGNsYXNzTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyhlbGVtZW50LCAnZC1ub25lJyk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVBbmltYXRpb25DbGFzc2VzKGVsOiBhbnkpIHtcbiAgICBpZiAodGhpcy5hbmltYXRpb25DbGFzcykge1xuICAgICAgY29uc3QgZWxlbWVudHMgPSB0aGlzLnN1cnJvdW5kaW5nRmlsdGVySXRlbSA/IFtlbCwgZWwucGFyZW50RWxlbWVudF0gOiBbZWxdO1xuICAgICAgZWxlbWVudHMuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoZWxlbWVudCwgJ2Qtbm9uZScpO1xuICAgICAgICB0aGlzLmFuaW1hdGlvbkNsYXNzLmZvckVhY2goKGNsYXNzTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldENsb3Nlc3RFbChlbDogYW55LCBzZWxlY3Rvcjogc3RyaW5nKSB7XG4gICAgZm9yICg7IGVsICYmIGVsICE9PSB0aGlzLmRvY3VtZW50OyBlbCA9IGVsLnBhcmVudE5vZGUpIHtcbiAgICAgIGlmIChlbC5tYXRjaGVzKHNlbGVjdG9yKSkge1xuICAgICAgICByZXR1cm4gZWw7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snLCBbJyRldmVudCddKSBvbkNsaWNrKGV2ZW50PzogYW55KSB7XG4gICAgaWYgKHRoaXMuX2dldENsb3Nlc3RFbChldmVudC50YXJnZXQsICcuaXRlbScpID09PSBudWxsKSB7XG4gICAgICB0aGlzLmZpbHRlclNlcnZpY2Uuc2V0RmlsdGVyKHRoaXMubWRiRmlsdGVyKTtcbiAgICAgIHRoaXMuZmlsdGVyU2VydmljZS5nZXRJdGVtcygpLmZvckVhY2goKGVsOiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25DbGFzcyA9IGVsLmdldEF0dHJpYnV0ZSgnZGF0YS1hbmltYXRpb24tY2xhc3MnKS5zcGxpdCgnLCcpO1xuICAgICAgICBpZiAodGhpcy5maWx0ZXJzLnByZXZpb3VzVmFsdWUgPT09ICcnIHx8IHRoaXMuZmlsdGVycy5wcmV2aW91c1ZhbHVlID09ICd1bmRlZmluZWQnIHx8IHRoaXMuZmlsdGVycy5wcmV2aW91c1ZhbHVlID09IHVuZGVmaW5lZCB8fCB0aGlzLmZpbHRlcnMgPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgaWYgKGVsLmdldEF0dHJpYnV0ZSgnZGF0YS1maWx0ZXItaXRlbScpID09IHRoaXMuZmlsdGVycy5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQW5pbWF0aW9uQ2xhc3NlcyhlbCk7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5hZGRBbmltYXRpb25DbGFzc2VzKGVsKTtcbiAgICAgICAgICAgIH0sIDE1KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubWRiRmlsdGVyID09ICcnKSB7XG4gICAgICAgICAgaWYgKGVsLmdldEF0dHJpYnV0ZSgnZGF0YS1maWx0ZXItaXRlbScpID09IHRoaXMuZmlsdGVycy5wcmV2aW91c1ZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUFuaW1hdGlvbkNsYXNzZXMoZWwpO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuYWRkQW5pbWF0aW9uQ2xhc3NlcyhlbCk7XG4gICAgICAgICAgICB9LCAxNSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudHMgPSB0aGlzLnN1cnJvdW5kaW5nRmlsdGVySXRlbSA/IFtlbCwgZWwucGFyZW50RWxlbWVudF0gOiBbZWxdO1xuICAgICAgICAgICAgZWxlbWVudHMuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoZWxlbWVudCwgJ2Qtbm9uZScpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLmFkZEFuaW1hdGlvbkNsYXNzZXMoZWwpO1xuICAgICAgICAgIH0sIDE1KTtcbiAgICAgICAgfSBlbHNlIGlmIChlbC5nZXRBdHRyaWJ1dGUoJ2RhdGEtZmlsdGVyLWl0ZW0nKSAhPT0gdGhpcy5tZGJGaWx0ZXIpIHtcbiAgICAgICAgICBjb25zdCBlbGVtZW50cyA9IHRoaXMuc3Vycm91bmRpbmdGaWx0ZXJJdGVtID8gW2VsLCBlbC5wYXJlbnRFbGVtZW50XSA6IFtlbF07XG4gICAgICAgICAgZWxlbWVudHMuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKGVsZW1lbnQsICdkLW5vbmUnKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzID0gdGhpcy5zdXJyb3VuZGluZ0ZpbHRlckl0ZW0gPyBbZWwsIGVsLnBhcmVudEVsZW1lbnRdIDogW2VsXTtcbiAgICAgICAgICAgIGVsZW1lbnRzLmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGVsZW1lbnQsICdkLW5vbmUnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sIDE1KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=