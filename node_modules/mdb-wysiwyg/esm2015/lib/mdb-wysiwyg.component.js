import { ChangeDetectorRef, Component, ElementRef, EventEmitter, forwardRef, Input, Output, Renderer2, ViewChild, ViewEncapsulation } from '@angular/core';
import { ALIGN_ITEMS, IMAGE_HREF_ITEMS, LIST_ITEMS, TEXT_COLOR_ITEMS, TEXT_DECORATION_ITEMS, TEXT_STYLE_ITEMS } from './mdb-defaults';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, takeUntil } from 'rxjs/operators';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
const VALUE_ACCESSOR = {
    provide: NG_VALUE_ACCESSOR,
    // tslint:disable-next-line: no-use-before-declare
    useExisting: forwardRef(() => MdbWysiwygComponent),
    multi: true
};
export class MdbWysiwygComponent {
    constructor(renderer, cdRef, el) {
        this.renderer = renderer;
        this.cdRef = cdRef;
        this.el = el;
        this._value = '';
        this.options = null;
        this.valueChange = new EventEmitter();
        this.valueContent = new EventEmitter();
        this.isTextStyleDropdownVisible = false;
        this.isTextColorDropdownVisible = false;
        this.selectedTextStyle = 'Paragraph';
        this.selectedTextColor = '#000';
        this.showTooltips = true;
        this.optionsLength = 0;
        this.textStyleItems = TEXT_STYLE_ITEMS;
        this.textColorItems = TEXT_COLOR_ITEMS;
        this.textDecorationItems = TEXT_DECORATION_ITEMS;
        this.alignItems = ALIGN_ITEMS;
        this.imageHrefItems = IMAGE_HREF_ITEMS;
        this.listItems = LIST_ITEMS;
        this._destroy = new Subject();
        this._htmlIsVisible = false;
        this.wysiwygValueChange$ = new Subject();
        this.onChange = (_) => { };
        this.onTouched = () => { };
    }
    get value() {
        return this._value;
    }
    set value(newValue) {
        if (newValue || newValue === '') {
            this._value = newValue;
            this.textarea.nativeElement.innerHTML = newValue;
        }
        else {
            this._value = '';
            this.textarea.nativeElement.innerHTML = '';
        }
        this.valueChange.emit(newValue);
        this.wysiwygValueChange$.next(newValue);
    }
    valueChange$() {
        return this.wysiwygValueChange$;
    }
    writeValue(value) {
        if (value || value === '') {
            this.value = value;
            this.textarea.nativeElement.innerHTML = this.value;
            this.wysiwygValueChange$.next(value);
            this.valueChange.emit(value);
            this.onChange(value);
            this.onTouched();
        }
    }
    valueChanged() {
        this.onChange(this.value);
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    setDisableState(isDisabled) { }
    selectTextStyle(item, event) {
        event.preventDefault();
        if (!this.options || !this.options.translations) {
            this.selectedTextStyle =
                item.text === 'Heading'
                    ? item.text + item.selector.toString().replace('h', ' ')
                    : item.text;
        }
        else {
            this.selectedTextStyle =
                item.text === this.options.translations['textElements'].heading
                    ? item.text + item.selector.toString().replace('h', ' ')
                    : item.text;
        }
        this.isTextStyleDropdownVisible = false;
        if (this.textStyleItems.findIndex(el => el.text === window.getSelection().anchorNode.textContent) === -1) {
            document.execCommand('formatBlock', false, `<${item.selector}>`);
        }
    }
    selectTextColor(item, event) {
        event.preventDefault();
        this.selectedTextColor = item.color;
        this.isTextColorDropdownVisible = false;
        document.execCommand('styleWithCSS', false, item.color);
        document.execCommand('foreColor', false, item.color);
    }
    performAction(action, event) {
        event.preventDefault();
        const selection = window.getSelection().anchorNode &&
            window.getSelection().anchorNode.parentElement.firstChild;
        if (selection) {
            if (this.textStyleItems.findIndex(el => el.text === window.getSelection().anchorNode.textContent) === -1) {
                if (action === 'color') {
                    this.isTextColorDropdownVisible = !this.isTextColorDropdownVisible;
                }
                document.execCommand(action);
            }
            const actions = [
                'justifyLeft',
                'justifyCenter',
                'justifyRight',
                'justifyFull',
                'createLink',
                'insertImage'
            ];
            if (actions.find(el => el === action)) {
                let value = null;
                if (action === 'createLink' || action === 'insertImage') {
                    const link = window.getSelection().getRangeAt(0).toString() || 'https://';
                    if (!this.options || !this.options.translations) {
                        value = prompt('Insert URL: ', link);
                    }
                    else {
                        value = prompt(`${action === 'createLink'
                            ? this.options.translations['imageAndLink'].linkURLPlaceholder
                            : this.options.translations['imageAndLink'].imageURLPlaceholder}`, link);
                    }
                    document.execCommand('delete', false);
                }
                document.execCommand(action, false, value);
            }
        }
    }
    toggleHTMLCode() {
        if (!this._htmlIsVisible) {
            this.textarea.nativeElement.textContent = this.textarea.nativeElement.innerHTML;
            this._htmlIsVisible = true;
        }
        else {
            this.textarea.nativeElement.innerHTML = this.textarea.nativeElement.innerText;
            this._htmlIsVisible = false;
        }
    }
    changeTooltipTranslation(array, el, value) {
        array.forEach((element) => {
            element[el] = value[element.type];
        });
    }
    ngAfterViewInit() {
        if (this.value || this.value === '') {
            this.textarea.nativeElement.innerHTML = this.value;
        }
        else {
            this.textarea.nativeElement.innerHTML = '';
        }
        this.renderer.listen(this.textarea.nativeElement, 'click', () => {
            this.isTextStyleDropdownVisible = false;
            this.isTextColorDropdownVisible = false;
        });
        fromEvent(this.el.nativeElement, 'input')
            .pipe(debounceTime(100), distinctUntilChanged(), takeUntil(this._destroy))
            .subscribe((event) => {
            this.wysiwygValueChange$.next(event.target.innerHTML);
            this.valueChange.emit(event.target.innerHTML);
            this.onChange(event.target.innerHTML);
            this.valueContent.emit(event.target.textContent);
            this.onTouched();
        });
        if (this.options) {
            this.optionsLength = Object.entries(this.options).length;
            if (this.options.translations) {
                Object.entries(this.options.translations).forEach(([key, value]) => {
                    switch (key) {
                        case 'textElements': {
                            this.selectedTextStyle = value.paragraph;
                            this.changeTooltipTranslation(TEXT_STYLE_ITEMS, 'text', value);
                            break;
                        }
                        case 'textStyle': {
                            this.changeTooltipTranslation(TEXT_DECORATION_ITEMS, 'tooltip', value);
                            break;
                        }
                        case 'textAlign': {
                            this.changeTooltipTranslation(ALIGN_ITEMS, 'tooltip', value);
                            break;
                        }
                        case 'imageAndLink': {
                            this.changeTooltipTranslation(IMAGE_HREF_ITEMS, 'tooltip', value);
                            break;
                        }
                        case 'lists': {
                            this.changeTooltipTranslation(LIST_ITEMS, 'tooltip', value);
                            break;
                        }
                        default: {
                            this.options.translations['showHTML'] = value;
                            break;
                        }
                    }
                    if (!this.options.translations['showHTML']) {
                        this.options.translations['showHTML'] = 'Show HTML Code';
                    }
                });
            }
            if (this.options.colors) {
                this.textColorItems = [];
                Object.entries(this.options.colors).forEach((color) => {
                    this.textColorItems.push({ name: color[0], color: color[1] });
                });
            }
        }
        if (!this.options || Object.entries(this.options).length === 0) {
            this.showTooltips = true;
        }
        else if (this.options && !this.options.tooltips) {
            this.showTooltips = false;
        }
        this.cdRef.detectChanges();
    }
    ngOnDestroy() {
        this._destroy.next();
        this._destroy.complete();
    }
}
MdbWysiwygComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line: component-selector
                selector: 'mdb-wysiwyg',
                template: "<div class=\"\">\n  <textarea id=\"demo\" style=\"width: 0px; height: 0px; visibility: hidden\" cols=\"30\" rows=\"10\"></textarea>\n  <div class=\"mdb-wysiwyg-container\">\n    <div class=\"mdb-wysiwyg-toolbar\">\n      <div class=\"mdb-wysiwyg-toolbar-group\">\n        <div class=\"mdb-wysiwyg-toolbar-dropdown\">\n          <div class=\"mdb-wysiwyg-toolbar-dropdown-toggle text-style-dropdown\"\n               (click)=\"isTextStyleDropdownVisible = !isTextStyleDropdownVisible\">\n            <button type=\"button\" class=\"btn-clear\">{{selectedTextStyle}}</button>\n          </div>\n          <ul class=\"mdb-wysiwyg-toolbar-options-list\"\n              [ngClass]=\"{'visible': isTextStyleDropdownVisible, 'hidden': !isTextStyleDropdownVisible}\">\n            <li *ngFor=\"let item of textStyleItems; let i = index\" (click)=\"selectTextStyle(item, $event)\">\n              <button type=\"button\" class=\"btn-clear w-100\">{{item.type === 'heading' ? item.text + ' ' + i : item.text}}</button>\n            </li>\n          </ul>\n        </div>\n      </div>\n      <div class=\"mdb-wysiwyg-toolbar-group\">\n        <button type=\"button\" *ngFor=\"let item of textDecorationItems; let i = index\"\n                (click)=\"performAction(item.type, $event)\"\n                [ngClass]=\"{'btn-clear': true, 'mdb-wysiwyg-toolbar-dropdown-toggle': i == textDecorationItems.length - 1}\"\n                [mdbTooltip]=\"showTooltips ? item.tooltip : ''\" placement=\"bottom\" triggers=\"hover click\">\n          <i class=\"{{item.icon}}\"></i>\n        </button>\n\n        <ul class=\"mdb-wysiwyg-toolbar-options-list mdb-wysiwyg-toolbar-color-palette\"\n            [ngClass]=\"{'visible': isTextColorDropdownVisible, 'hidden': !isTextColorDropdownVisible}\">\n          <li *ngFor=\"let item of textColorItems; let i = index\" (click)=\"selectTextColor(item, $event)\"\n              [ngClass]=\"{'visible': isTextColorDropdownVisible, 'hidden': !isTextColorDropdownVisible}\">\n            <button type=\"button\" class=\"btn-clear\" [ngStyle]=\"{'background-color': item.color}\"></button>\n          </li>\n        </ul>\n      </div>\n      <div class=\"mdb-wysiwyg-toolbar-group\">\n        <ul class=\"mdb-wysiwyg-toolbar-options\">\n          <li *ngFor=\"let item of alignItems; let i = index\" (click)=\"performAction(item.type, $event)\">\n            <button type=\"button\" class=\"btn-clear\" [mdbTooltip]=\"showTooltips  ? item.tooltip : ''\" placement=\"bottom\"\n                    triggers=\"hover click\">\n              <i class=\"{{item.icon}}\"></i>\n            </button>\n          </li>\n        </ul>\n      </div>\n      <div class=\"mdb-wysiwyg-toolbar-group\">\n        <ul class=\"mdb-wysiwyg-toolbar-options\">\n          <li *ngFor=\"let item of imageHrefItems; let i = index\" (click)=\"performAction(item.type, $event)\">\n            <button type=\"button\" class=\"btn-clear\" [mdbTooltip]=\"showTooltips  ? item.tooltip : ''\" placement=\"bottom\"\n                    triggers=\"hover click\">\n              <i class=\"{{item.icon}}\"></i>\n            </button>\n          </li>\n        </ul>\n      </div>\n      <div class=\"mdb-wysiwyg-toolbar-group\">\n        <ul class=\"mdb-wysiwyg-toolbar-options\">\n          <li *ngFor=\"let item of listItems; let i = index\" (click)=\"performAction(item.type, $event)\">\n            <button type=\"button\" class=\"btn-clear\" [mdbTooltip]=\"showTooltips  ? item.tooltip : ''\" placement=\"bottom\"\n                    triggers=\"hover click\">\n              <i class=\"{{item.icon}}\"></i>\n            </button>\n          </li>\n        </ul>\n      </div>\n      <div class=\"mdb-wysiwyg-toolbar-group\">\n        <ul class=\"mdb-wysiwyg-toolbar-options\">\n          <li (click)=\"toggleHTMLCode()\">\n            <button type=\"button\" class=\"btn-clear\" *ngIf=\"options && options.tooltips\"\n                    [mdbTooltip]=\"options && options.translations ? options.translations['showHTML'] : 'Show HTML Code'\"\n                    placement=\"bottom\" triggers=\"hover click\">\n              <i class=\"fas fa-code\"></i>\n            </button>\n\n            <button type=\"button\" class=\"btn-clear\" *ngIf=\"options && !options.tooltips; else showHTML\"\n                    [mdbTooltip]=\"options && !options.tooltips && showTooltips ? 'Show HTML Code' : ''\"\n                    placement=\"bottom\"\n                    triggers=\"hover click\">\n              <i class=\"fas fa-code\"></i>\n            </button>\n\n            <ng-template #showHTML>\n              <button type=\"button\" class=\"btn-clear\" *ngIf=\"optionsLength === 0\"\n                      [mdbTooltip]=\"optionsLength === 0 ? 'Show HTML Code' : ''\" placement=\"bottom\" triggers=\"hover click\">\n                <i class=\"fas fa-code\"></i>\n              </button>\n            </ng-template>\n          </li>\n        </ul>\n      </div>\n    </div>\n    <div class=\"mdb-wysiwyg-textarea\" #textarea contenteditable=\"true\">\n    </div>\n  </div>\n</div>\n",
                providers: [VALUE_ACCESSOR],
                encapsulation: ViewEncapsulation.None,
                styles: [".mdb-wysiwyg-container{display:block;border:1px solid #ededed;border-radius:3px 3px 0 0}.mdb-wysiwyg-toolbar-dropdown-toggle.text-style-dropdown:after{content:\"\";display:inline-block;border-style:solid;border-width:3px;border-color:#888 transparent transparent;right:0;margin-left:0}.mdb-wysiwyg-toolbar-color-palette{margin-top:26px}.btn-clear{background:transparent;border:0;cursor:pointer}.mdb-wysiwyg-toolbar{display:flex;flex-wrap:wrap;justify-content:space-between;padding-left:8px;padding-right:8px;border-top:1px solid #fff;border-bottom:1px solid #d9dad9;border-radius:3px 3px 0 0;background:#f4f4f4;background:linear-gradient(#f4f4f4,#efeeee)}.mdb-wysiwyg-toolbar-options{list-style:none;margin:5px 0;padding-left:0}.mdb-wysiwyg-toolbar-options li{display:inline-block;padding-left:0}.mdb-wysiwyg-toolbar-options button{color:#555;background:transparent;border:none;border-radius:3px;cursor:pointer}.mdb-wysiwyg-toolbar-options button:focus{outline:0}.mdb-wysiwyg-toolbar-options button.active{border:1px solid #ccc;box-shadow:inset 0 0 13px #00000025}.mdb-wysiwyg-toolbar-options-list{visibility:hidden;position:absolute;background:#fff;box-shadow:0 2px 4px #0003;border:1px solid rgba(0,0,0,.2);list-style:none;font-size:.8rem;padding-left:0;z-index:99;opacity:0;transition:opacity .2s}.mdb-wysiwyg-toolbar-options-list.visible{visibility:visible;opacity:1}.mdb-wysiwyg-toolbar-options-list li{display:block}.mdb-wysiwyg-toolbar-options-list button{display:block;padding:4px 10px;color:#000;cursor:pointer}.mdb-wysiwyg-toolbar-options-list button:hover{background:#eee}.mdb-wysiwyg-toolbar-group{display:flex}.mdb-wysiwyg-toolbar-dropdown{align-self:center}.mdb-wysiwyg-toolbar-dropdown-toggle{font-size:.875rem;color:#555;border:0;background:transparent;cursor:pointer}.mdb-wysiwyg-toolbar-dropdown-toggle:focus{outline:0}.mdb-wysiwyg-toolbar-dropdown-toggle:after{content:\"\";display:inline-block;border-style:solid;border-width:3px;border-color:#888 transparent transparent;right:0;margin-left:5px}.mdb-wysiwyg-toolbar-color-palette{display:grid;grid-template-columns:repeat(5,1fr);grid-gap:3px;padding:3px}.mdb-wysiwyg-toolbar-color-palette li{padding:0}.mdb-wysiwyg-toolbar-color-palette button{display:block;width:14px;height:14px;border:1px solid rgba(0,0,0,.15);border-radius:0}.mdb-wysiwyg-textarea{display:block;padding:15px;width:100%;height:450px;border:0;resize:none;overflow:auto;background:#fff}.mdb-wysiwyg-textarea.show-raw{white-space:pre-line}.mdb-wysiwyg-textarea:focus{outline:0}.mdb-wysiwyg-textarea b,.mdb-wysiwyg-textarea strong{font-weight:bold}\n"]
            },] }
];
MdbWysiwygComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ChangeDetectorRef },
    { type: ElementRef }
];
MdbWysiwygComponent.propDecorators = {
    value: [{ type: Input }],
    options: [{ type: Input }],
    valueChange: [{ type: Output }],
    valueContent: [{ type: Output }],
    textarea: [{ type: ViewChild, args: ['textarea', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLXd5c2l3eWcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbWRiLXd5c2l3eWcvc3JjL2xpYi9tZGItd3lzaXd5Zy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixTQUFTLEVBQ1QsU0FBUyxFQUVULGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQ0wsV0FBVyxFQUNYLGdCQUFnQixFQUNoQixVQUFVLEVBQ1YsZ0JBQWdCLEVBQ2hCLHFCQUFxQixFQUNyQixnQkFBZ0IsRUFDakIsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsU0FBUyxFQUFjLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDcEUsT0FBTyxFQUNMLFlBQVksRUFDWixvQkFBb0IsRUFFcEIsU0FBUyxFQUNWLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbkQsTUFBTSxjQUFjLEdBQUc7SUFDckIsT0FBTyxFQUFFLGlCQUFpQjtJQUMxQixrREFBa0Q7SUFDbEQsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQztJQUNsRCxLQUFLLEVBQUUsSUFBSTtDQUNaLENBQUM7QUFVRixNQUFNLE9BQU8sbUJBQW1CO0lBb0Y5QixZQUNVLFFBQW1CLEVBQ25CLEtBQXdCLEVBQ3hCLEVBQWM7UUFGZCxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLFVBQUssR0FBTCxLQUFLLENBQW1CO1FBQ3hCLE9BQUUsR0FBRixFQUFFLENBQVk7UUF0RWhCLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFDWCxZQUFPLEdBSVosSUFBSSxD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SSxDQUFDO1NBQzFCO2FBQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7WUFDakQsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7U0FDM0I7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFDRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzNCLENBQUM7OztZQTFSRixTQUFTLFNBQUM7Z0JBQ1QsK0NBQStDO2dCQUMvQyxRQUFRLEVBQUUsYUFBYTtnQkFDdkIsMjlKQUEyQztnQkFFM0MsU0FBUyxFQUFFLENBQUMsY0FBYyxDQUFDO2dCQUMzQixhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTs7YUFDdEM7OztZQXBDQyxTQUFTO1lBUFQsaUJBQWlCO1lBRWpCLFVBQVU7OztvQkEyQ1QsS0FBSztzQkFpQkwsS0FBSzswQkFNTCxNQUFNOzJCQUVOLE1BQU07dUJBRU4sU0FBUyxTQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIFJlbmRlcmVyMixcbiAgVmlld0NoaWxkLFxuICBPbkRlc3Ryb3ksXG4gIFZpZXdFbmNhcHN1bGF0aW9uXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQUxJR05fSVRFTVMsXG4gIElNQUdFX0hSRUZfSVRFTVMsXG4gIExJU1RfSVRFTVMsXG4gIFRFWFRfQ09MT1JfSVRFTVMsXG4gIFRFWFRfREVDT1JBVElPTl9JVEVNUyxcbiAgVEVYVF9TVFlMRV9JVEVNU1xufSBmcm9tICcuL21kYi1kZWZhdWx0cyc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZGVib3VuY2VUaW1lLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgbWFwLFxuICB0YWtlVW50aWxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTkdfVkFMVUVfQUNDRVNTT1IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbmNvbnN0IFZBTFVFX0FDQ0VTU09SID0ge1xuICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11c2UtYmVmb3JlLWRlY2xhcmVcbiAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTWRiV3lzaXd5Z0NvbXBvbmVudCksXG4gIG11bHRpOiB0cnVlXG59O1xuXG5AQ29tcG9uZW50KHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjb21wb25lbnQtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICdtZGItd3lzaXd5ZycsXG4gIHRlbXBsYXRlVXJsOiAnLi9tZGItd3lzaXd5Zy5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL21kYi13eXNpd3lnLmNvbXBvbmVudC5zY3NzJ10sXG4gIHByb3ZpZGVyczogW1ZBTFVFX0FDQ0VTU09SXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBNZGJXeXNpd3lnQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcbiAgQElucHV0KClcbiAgZ2V0IHZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZTtcbiAgfVxuICBzZXQgdmFsdWUobmV3VmFsdWU6IHN0cmluZykge1xuICAgIGlmIChuZXdWYWx1ZSB8fCBuZXdWYWx1ZSA9PT0gJycpIHtcbiAgICAgIHRoaXMuX3ZhbHVlID0gbmV3VmFsdWU7XG4gICAgICB0aGlzLnRleHRhcmVhLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID0gbmV3VmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3ZhbHVlID0gJyc7XG4gICAgICB0aGlzLnRleHRhcmVhLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID0gJyc7XG4gICAgfVxuXG4gICAgdGhpcy52YWx1ZUNoYW5nZS5lbWl0KG5ld1ZhbHVlKTtcbiAgICB0aGlzLnd5c2l3eWdWYWx1ZUNoYW5nZSQubmV4dChuZXdWYWx1ZSk7XG4gIH1cbiAgcHJpdmF0ZSBfdmFsdWUgPSAnJztcbiAgQElucHV0KCkgb3B0aW9uczoge1xuICAgIHRvb2x0aXBzOiBib29sZWFuO1xuICAgIHRyYW5zbGF0aW9uczogQXJyYXk8YW55PjtcbiAgICBjb2xvcnM6IEFycmF5PGFueT47XG4gIH0gPSBudWxsO1xuXG4gIEBPdXRwdXQoKSB2YWx1ZUNoYW5nZTogRXZlbnRFbWl0dGVyPHN0cmluZz4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICBAT3V0cHV0KCkgdmFsdWVDb250ZW50OiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIEBWaWV3Q2hpbGQoJ3RleHRhcmVhJywgeyBzdGF0aWM6IHRydWUgfSkgdGV4dGFyZWE6IEVsZW1lbnRSZWY7XG5cbiAgaXNUZXh0U3R5bGVEcm9wZG93blZpc2libGUgPSBmYWxzZTtcbiAgaXNUZXh0Q29sb3JEcm9wZG93blZpc2libGUgPSBmYWxzZTtcblxuICBzZWxlY3RlZFRleHRTdHlsZSA9ICdQYXJhZ3JhcGgnO1xuICBzZWxlY3RlZFRleHRDb2xvciA9ICcjMDAwJztcblxuICBzaG93VG9vbHRpcHMgPSB0cnVlO1xuICBvcHRpb25zTGVuZ3RoID0gMDtcblxuICB0ZXh0U3R5bGVJdGVtcyA9IFRFWFRfU1RZTEVfSVRFTVM7XG4gIHRleHRDb2xvckl0ZW1zID0gVEVYVF9DT0xPUl9JVEVNUztcbiAgdGV4dERlY29yYXRpb25JdGVtcyA9IFRFWFRfREVDT1JBVElPTl9JVEVNUztcbiAgYWxpZ25JdGVtcyA9IEFMSUdOX0lURU1TO1xuICBpbWFnZUhyZWZJdGVtcyA9IElNQUdFX0hSRUZfSVRFTVM7XG4gIGxpc3RJdGVtcyA9IExJU1RfSVRFTVM7XG5cbiAgcHJpdmF0ZSBfZGVzdHJveSA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcHJpdmF0ZSBfaHRtbElzVmlzaWJsZSA9IGZhbHNlO1xuXG4gIHByaXZhdGUgd3lzaXd5Z1ZhbHVlQ2hhbmdlJDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gIHB1YmxpYyB2YWx1ZUNoYW5nZSQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy53eXNpd3lnVmFsdWVDaGFuZ2UkO1xuICB9XG5cbiAgb25DaGFuZ2UgPSAoXzogYW55KSA9PiB7fTtcbiAgb25Ub3VjaGVkID0gKCkgPT4ge307XG5cbiAgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KSB7XG4gICAgaWYgKHZhbHVlIHx8IHZhbHVlID09PSAnJykge1xuICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuICAgICAgdGhpcy50ZXh0YXJlYS5uYXRpdmVFbGVtZW50LmlubmVySFRNTCA9IHRoaXMudmFsdWU7XG4gICAgICB0aGlzLnd5c2l3eWdWYWx1ZUNoYW5nZSQubmV4dCh2YWx1ZSk7XG4gICAgICB0aGlzLnZhbHVlQ2hhbmdlLmVtaXQodmFsdWUpO1xuICAgICAgdGhpcy5vbkNoYW5nZSh2YWx1ZSk7XG4gICAgICB0aGlzLm9uVG91Y2hlZCgpO1xuICAgIH1cbiAgfVxuXG4gIHZhbHVlQ2hhbmdlZCgpIHtcbiAgICB0aGlzLm9uQ2hhbmdlKHRoaXMudmFsdWUpO1xuICB9XG5cbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKF86IGFueSkgPT4gdm9pZCkge1xuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcbiAgfVxuXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcbiAgfVxuXG4gIHNldERpc2FibGVTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7fVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmXG4gICkge31cblxuICBwdWJsaWMgc2VsZWN0VGV4dFN0eWxlKGl0ZW06IGFueSwgZXZlbnQ6IGFueSkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKCF0aGlzLm9wdGlvbnMgfHwgIXRoaXMub3B0aW9ucy50cmFuc2xhdGlvbnMpIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRUZXh0U3R5bGUgPVxuICAgICAgICBpdGVtLnRleHQgPT09ICdIZWFkaW5nJ1xuICAgICAgICAgID8gaXRlbS50ZXh0ICsgaXRlbS5zZWxlY3Rvci50b1N0cmluZygpLnJlcGxhY2UoJ2gnLCAnICcpXG4gICAgICAgICAgOiBpdGVtLnRleHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRUZXh0U3R5bGUgPVxuICAgICAgICBpdGVtLnRleHQgPT09IHRoaXMub3B0aW9ucy50cmFuc2xhdGlvbnNbJ3RleHRFbGVtZW50cyddLmhlYWRpbmdcbiAgICAgICAgICA/IGl0ZW0udGV4dCArIGl0ZW0uc2VsZWN0b3IudG9TdHJpbmcoKS5yZXBsYWNlKCdoJywgJyAnKVxuICAgICAgICAgIDogaXRlbS50ZXh0O1xuICAgIH1cbiAgICB0aGlzLmlzVGV4dFN0eWxlRHJvcGRvd25WaXNpYmxlID0gZmFsc2U7XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLnRleHRTdHlsZUl0ZW1zLmZpbmRJbmRleChcbiAgICAgICAgZWwgPT4gZWwudGV4dCA9PT0gd2luZG93LmdldFNlbGVjdGlvbigpLmFuY2hvck5vZGUudGV4dENvbnRlbnRcbiAgICAgICkgPT09IC0xXG4gICAgKSB7XG4gICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgnZm9ybWF0QmxvY2snLCBmYWxzZSwgYDwke2l0ZW0uc2VsZWN0b3J9PmApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZWxlY3RUZXh0Q29sb3IoaXRlbTogYW55LCBldmVudDogYW55KSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB0aGlzLnNlbGVjdGVkVGV4dENvbG9yID0gaXRlbS5jb2xvcjtcbiAgICB0aGlzLmlzVGV4dENvbG9yRHJvcGRvd25WaXNpYmxlID0gZmFsc2U7XG5cbiAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgnc3R5bGVXaXRoQ1NTJywgZmFsc2UsIGl0ZW0uY29sb3IpO1xuICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCdmb3JlQ29sb3InLCBmYWxzZSwgaXRlbS5jb2xvcik7XG4gIH1cblxuICBwdWJsaWMgcGVyZm9ybUFjdGlvbihhY3Rpb246IHN0cmluZywgZXZlbnQ6IGFueSkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgY29uc3Qgc2VsZWN0aW9uID1cbiAgICAgIHdpbmRvdy5nZXRTZWxlY3Rpb24oKS5hbmNob3JOb2RlICYmXG4gICAgICB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkuYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50LmZpcnN0Q2hpbGQ7XG5cbiAgICBpZiAoc2VsZWN0aW9uKSB7XG4gICAgICBpZiAoXG4gICAgICAgIHRoaXMudGV4dFN0eWxlSXRlbXMuZmluZEluZGV4KFxuICAgICAgICAgIGVsID0+IGVsLnRleHQgPT09IHdpbmRvdy5nZXRTZWxlY3Rpb24oKS5hbmNob3JOb2RlLnRleHRDb250ZW50XG4gICAgICAgICkgPT09IC0xXG4gICAgICApIHtcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ2NvbG9yJykge1xuICAgICAgICAgIHRoaXMuaXNUZXh0Q29sb3JEcm9wZG93blZpc2libGUgPSAhdGhpcy5pc1RleHRDb2xvckRyb3Bkb3duVmlzaWJsZTtcbiAgICAgICAgfVxuICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChhY3Rpb24pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhY3Rpb25zID0gW1xuICAgICAgICAnanVzdGlmeUxlZnQnLFxuICAgICAgICAnanVzdGlmeUNlbnRlcicsXG4gICAgICAgICdqdXN0aWZ5UmlnaHQnLFxuICAgICAgICAnanVzdGlmeUZ1bGwnLFxuICAgICAgICAnY3JlYXRlTGluaycsXG4gICAgICAgICdpbnNlcnRJbWFnZSdcbiAgICAgIF07XG5cbiAgICAgIGlmIChhY3Rpb25zLmZpbmQoZWwgPT4gZWwgPT09IGFjdGlvbikpIHtcbiAgICAgICAgbGV0IHZhbHVlID0gbnVsbDtcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ2NyZWF0ZUxpbmsnIHx8IGFjdGlvbiA9PT0gJ2luc2VydEltYWdlJykge1xuICAgICAgICAgIGNvbnN0IGxpbmsgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkuZ2V0UmFuZ2VBdCgwKS50b1N0cmluZygpIHx8ICdodHRwczovLyc7XG4gICAgICAgICAgXG4gICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMgfHwgIXRoaXMub3B0aW9ucy50cmFuc2xhdGlvbnMpIHtcbiAgICAgICAgICAgIHZhbHVlID0gcHJvbXB0KCdJbnNlcnQgVVJMOiAnLCBsaW5rKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFsdWUgPSBwcm9tcHQoXG4gICAgICAgICAgICAgIGAke2FjdGlvbiA9PT0gJ2NyZWF0ZUxpbmsnXG4gICAgICAgICAgICAgICAgPyB0aGlzLm9wdGlvbnMudHJhbnNsYXRpb25zWydpbWFnZUFuZExpbmsnXS5saW5rVVJMUGxhY2Vob2xkZXJcbiAgICAgICAgICAgICAgICA6IHRoaXMub3B0aW9ucy50cmFuc2xhdGlvbnNbJ2ltYWdlQW5kTGluayddLmltYWdlVVJMUGxhY2Vob2xkZXJcbiAgICAgICAgICAgICAgfWAsXG4gICAgICAgICAgICAgIGxpbmtcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2RlbGV0ZScsIGZhbHNlKVxuICAgICAgICB9XG4gICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKGFjdGlvbiwgZmFsc2UsIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdG9nZ2xlSFRNTENvZGUoKSB7XG4gICAgaWYgKCF0aGlzLl9odG1sSXNWaXNpYmxlKSB7XG4gICAgICB0aGlzLnRleHRhcmVhLm5hdGl2ZUVsZW1lbnQudGV4dENvbnRlbnQgPSB0aGlzLnRleHRhcmVhLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MO1xuICAgICAgdGhpcy5faHRtbElzVmlzaWJsZSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGV4dGFyZWEubmF0aXZlRWxlbWVudC5pbm5lckhUTUwgPSB0aGlzLnRleHRhcmVhLm5hdGl2ZUVsZW1lbnQuaW5uZXJUZXh0O1xuICAgICAgdGhpcy5faHRtbElzVmlzaWJsZSA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZVRvb2x0aXBUcmFuc2xhdGlvbihhcnJheTogQXJyYXk8YW55PiwgZWw6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIGFycmF5LmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4ge1xuICAgICAgZWxlbWVudFtlbF0gPSB2YWx1ZVtlbGVtZW50LnR5cGVdO1xuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnZhbHVlIHx8IHRoaXMudmFsdWUgPT09ICcnKSB7XG4gICAgICB0aGlzLnRleHRhcmVhLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID0gdGhpcy52YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50ZXh0YXJlYS5uYXRpdmVFbGVtZW50LmlubmVySFRNTCA9ICcnO1xuICAgIH1cblxuICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMudGV4dGFyZWEubmF0aXZlRWxlbWVudCwgJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgdGhpcy5pc1RleHRTdHlsZURyb3Bkb3duVmlzaWJsZSA9IGZhbHNlO1xuICAgICAgdGhpcy5pc1RleHRDb2xvckRyb3Bkb3duVmlzaWJsZSA9IGZhbHNlO1xuICAgIH0pO1xuXG4gICAgZnJvbUV2ZW50KHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2lucHV0JylcbiAgICAgIC5waXBlKFxuICAgICAgICBkZWJvdW5jZVRpbWUoMTAwKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMud3lzaXd5Z1ZhbHVlQ2hhbmdlJC5uZXh0KGV2ZW50LnRhcmdldC5pbm5lckhUTUwpO1xuICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlLmVtaXQoZXZlbnQudGFyZ2V0LmlubmVySFRNTCk7XG4gICAgICAgIHRoaXMub25DaGFuZ2UoZXZlbnQudGFyZ2V0LmlubmVySFRNTCk7XG4gICAgICAgIHRoaXMudmFsdWVDb250ZW50LmVtaXQoZXZlbnQudGFyZ2V0LnRleHRDb250ZW50KTtcbiAgICAgICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgICAgIH0pO1xuXG4gICAgaWYgKHRoaXMub3B0aW9ucykge1xuICAgICAgdGhpcy5vcHRpb25zTGVuZ3RoID0gT2JqZWN0LmVudHJpZXModGhpcy5vcHRpb25zKS5sZW5ndGg7XG4gICAgICBpZiAodGhpcy5vcHRpb25zLnRyYW5zbGF0aW9ucykge1xuICAgICAgICBPYmplY3QuZW50cmllcyh0aGlzLm9wdGlvbnMudHJhbnNsYXRpb25zKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgICAgICAgY2FzZSAndGV4dEVsZW1lbnRzJzoge1xuICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkVGV4dFN0eWxlID0gdmFsdWUucGFyYWdyYXBoO1xuICAgICAgICAgICAgICB0aGlzLmNoYW5nZVRvb2x0aXBUcmFuc2xhdGlvbihURVhUX1NUWUxFX0lURU1TLCAndGV4dCcsIHZhbHVlKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlICd0ZXh0U3R5bGUnOiB7XG4gICAgICAgICAgICAgIHRoaXMuY2hhbmdlVG9vbHRpcFRyYW5zbGF0aW9uKFxuICAgICAgICAgICAgICAgIFRFWFRfREVDT1JBVElPTl9JVEVNUyxcbiAgICAgICAgICAgICAgICAndG9vbHRpcCcsXG4gICAgICAgICAgICAgICAgdmFsdWVcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlICd0ZXh0QWxpZ24nOiB7XG4gICAgICAgICAgICAgIHRoaXMuY2hhbmdlVG9vbHRpcFRyYW5zbGF0aW9uKEFMSUdOX0lURU1TLCAndG9vbHRpcCcsIHZhbHVlKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlICdpbWFnZUFuZExpbmsnOiB7XG4gICAgICAgICAgICAgIHRoaXMuY2hhbmdlVG9vbHRpcFRyYW5zbGF0aW9uKElNQUdFX0hSRUZfSVRFTVMsICd0b29sdGlwJywgdmFsdWUpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgJ2xpc3RzJzoge1xuICAgICAgICAgICAgICB0aGlzLmNoYW5nZVRvb2x0aXBUcmFuc2xhdGlvbihMSVNUX0lURU1TLCAndG9vbHRpcCcsIHZhbHVlKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICAgIHRoaXMub3B0aW9ucy50cmFuc2xhdGlvbnNbJ3Nob3dIVE1MJ10gPSB2YWx1ZTtcblxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMudHJhbnNsYXRpb25zWydzaG93SFRNTCddKSB7XG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMudHJhbnNsYXRpb25zWydzaG93SFRNTCddID0gJ1Nob3cgSFRNTCBDb2RlJztcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMub3B0aW9ucy5jb2xvcnMpIHtcbiAgICAgICAgdGhpcy50ZXh0Q29sb3JJdGVtcyA9IFtdO1xuICAgICAgICBPYmplY3QuZW50cmllcyh0aGlzLm9wdGlvbnMuY29sb3JzKS5mb3JFYWNoKChjb2xvcjogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy50ZXh0Q29sb3JJdGVtcy5wdXNoKHsgbmFtZTogY29sb3JbMF0sIGNvbG9yOiBjb2xvclsxXSB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5vcHRpb25zIHx8IE9iamVjdC5lbnRyaWVzKHRoaXMub3B0aW9ucykubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLnNob3dUb29sdGlwcyA9IHRydWU7XG4gICAgfSBlbHNlIGlmICh0aGlzLm9wdGlvbnMgJiYgIXRoaXMub3B0aW9ucy50b29sdGlwcykge1xuICAgICAgdGhpcy5zaG93VG9vbHRpcHMgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fZGVzdHJveS5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveS5jb21wbGV0ZSgpO1xuICB9XG59XG4iXX0=