import { Directive, ElementRef, ContentChildren, Output, EventEmitter, Input, Inject } from '@angular/core';
import { MdbSortableDirective } from './mdb-sortable.directive';
import { DOCUMENT } from '@angular/common';
import { MdbSortableService } from './mdb-sortable.service';
import { Subject, empty } from 'rxjs';
import { tap, takeUntil, first, switchMap } from 'rxjs/operators';
export class MdbSortableListDirective {
    constructor(el, _document, sortableService) {
        this.el = el;
        this._document = _document;
        this.sortableService = sortableService;
        this.autoScroll = false;
        this.drop = new EventEmitter();
        this.destroy$ = new Subject();
        this._scrollSpeed = 10;
        this._scrollSensitivity = 20;
    }
    ngOnInit() { }
    ngAfterContentInit() {
        this._sortables.changes.subscribe(result => {
            this._sortables = result;
        });
        const drag = this.sortableService.dragStart.pipe(switchMap((event) => {
            if (this._sortables.toArray().find(el => event === el)) {
                this._previousList = this._currentList = this;
                this._currentIndex = this._sortables
                    .toArray()
                    .findIndex((el) => event === el);
                this._newIndex = this._currentIndex;
                return this.sortableService.dragMove.pipe(tap((moveEvent) => {
                    this.onSort(moveEvent.pointerPosition, moveEvent.placeholder, moveEvent.helper);
                }), takeUntil(drop));
            }
            else {
                return empty();
            }
        }), takeUntil(this.destroy$));
        const drop = this.sortableService.dragStart.pipe(switchMap((event) => {
            if (this._sortables.toArray().find(el => event === el)) {
                return this.sortableService.dragEnd.pipe(first(), tap(() => {
                    this.onDragEnd();
                }));
            }
            else {
                return empty();
            }
        }), takeUntil(this.destroy$));
        drag.subscribe();
        drop.subscribe();
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    _sortItems(dragged, hovered) {
        const draggedParent = dragged.parentNode;
        const hoveredParent = hovered.parentNode;
        if (draggedParent !== hoveredParent) {
            hoveredParent.insertBefore(dragged, hovered);
        }
        else {
            const temp = this._document.createElement('div');
            draggedParent.insertBefore(temp, dragged);
            hoveredParent.insertBefore(dragged, hovered);
            draggedParent.insertBefore(hovered, temp);
            draggedParent.removeChild(temp);
        }
    }
    _updateScrollPos(sortableElement) {
        const el = this.el.nativeElement;
        const elRect = sortableElement.getBoundingClientRect();
        const height = el.clientHeight;
        const width = el.clientWidth;
        if (elRect.top < this._scrollSensitivity) {
            el.scrollTop -= this._scrollSpeed;
        }
        if (elRect.top + elRect.height > height - this._scrollSensitivity) {
            el.scrollTop += this._scrollSpeed;
        }
        if (elRect.left < this._scrollSensitivity) {
            el.scrollLeft -= this._scrollSpeed;
        }
        if (elRect.left + elRect.width > width - this._scrollSensitivity) {
            el.scrollLeft += this._scrollSpeed;
        }
    }
    _isPointerOverItem(item, x, y) {
        const { top, bottom, left, right } = item.getBoundingClientRect();
        return y >= top && y <= bottom && x >= left && x <= right;
    }
    onSort(pointerPosition, placeholder, helper) {
        let lists;
        if (this.connectedWith) {
            lists = this.connectedWith.slice();
        }
        const currentItem = placeholder;
        let container = this._sortables;
        this._previousList = this;
        this._currentList = this._previousList;
        let activeList = this.el.nativeElement;
        if (this.autoScroll) {
            this._updateScrollPos(helper);
        }
        if (lists && lists.length) {
            lists.forEach(list => {
                if (this._isPointerOverItem(list.el.nativeElement, pointerPosition.x, pointerPosition.y)) {
                    container = list._sortables;
                    activeList = list.el.nativeElement;
                    this._currentList = list;
                }
                else if (this._isPointerOverItem(this.el.nativeElement, pointerPosition.x, pointerPosition.y)) {
                    container = this._sortables;
                    activeList = this.el.nativeElement;
                    this._currentList = this._previousList;
                }
            });
        }
        const sortables = container;
        sortables.forEach(item => {
            if (this._isPointerOverItem(item.el.nativeElement, pointerPosition.x, pointerPosition.y)) {
                this._sortItems(currentItem, item.el.nativeElement);
                const list = Array.from(activeList.children);
                this._newIndex = list.findIndex((el) => el === currentItem);
            }
        });
    }
    onDragEnd() {
        this.drop.emit({
            currentList: this._currentList,
            previousList: this._previousList,
            oldIndex: this._currentIndex,
            newIndex: this._newIndex
        });
    }
}
MdbSortableListDirective.decorators = [
    { type: Directive, args: [{
                selector: '[mdbSortableList]',
                exportAs: 'mdbSortableList'
            },] }
];
MdbSortableListDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: MdbSortableService }
];
MdbSortableListDirective.propDecorators = {
    _sortables: [{ type: ContentChildren, args: [MdbSortableDirective,] }],
    autoScroll: [{ type: Input }],
    connectedWith: [{ type: Input }],
    data: [{ type: Input }],
    drop: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLXNvcnRhYmxlLWxpc3QuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbWRiLXNvcnRhYmxlL3NyYy9saWIvbWRiLXNvcnRhYmxlLWxpc3QuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBRVQsVUFBVSxFQUNWLGVBQWUsRUFHZixNQUFNLEVBQ04sWUFBWSxFQUNaLEtBQUssRUFDTCxNQUFNLEVBRVAsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFDTCxHQUFHLEVBQ0gsU0FBUyxFQUNULEtBQUssRUFDTCxTQUFTLEVBQ1YsTUFBTSxnQkFBZ0IsQ0FBQztBQU14QixNQUFNLE9BQU8sd0JBQXdCO0lBc0JuQyxZQUNVLEVBQWMsRUFDSSxTQUFjLEVBQ2hDLGVBQW1DO1FBRm5DLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDSSxjQUFTLEdBQVQsU0FBUyxDQUFLO1FBQ2hDLG9CQUFlLEdBQWYsZUFBZSxDQUFvQjtRQXJCcEMsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUdsQixTQUFJLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVqQyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQU85QixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQix1QkFBa0IsR0FBRyxFQUFFLENBQUM7SUFTN0IsQ0FBQztJQUVKLFFBQVEsS0FBSSxDQUFDO0lBRWIsa0JBQWtCO1FBQ2hCLElBQUksQ0FBQyxVQUFVLENBQUMs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QUFDLFNBQVM7U0FDekIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7O1lBakxGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsbUJBQW1CO2dCQUM3QixRQUFRLEVBQUUsaUJBQWlCO2FBQzVCOzs7WUF4QkMsVUFBVTs0Q0FpRFAsTUFBTSxTQUFDLFFBQVE7WUFyQ1gsa0JBQWtCOzs7eUJBZXhCLGVBQWUsU0FBQyxvQkFBb0I7eUJBRXBDLEtBQUs7NEJBQ0wsS0FBSzttQkFDTCxLQUFLO21CQUNMLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIE9uSW5pdCxcbiAgRWxlbWVudFJlZixcbiAgQ29udGVudENoaWxkcmVuLFxuICBRdWVyeUxpc3QsXG4gIEFmdGVyQ29udGVudEluaXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgSW5qZWN0LFxuICBPbkRlc3Ryb3lcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNZGJTb3J0YWJsZURpcmVjdGl2ZSB9IGZyb20gJy4vbWRiLXNvcnRhYmxlLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBNZGJTb3J0YWJsZVNlcnZpY2UgfSBmcm9tICcuL21kYi1zb3J0YWJsZS5zZXJ2aWNlJztcbmltcG9ydCB7IFN1YmplY3QsIGVtcHR5IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICB0YXAsXG4gIHRha2VVbnRpbCxcbiAgZmlyc3QsXG4gIHN3aXRjaE1hcFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1ttZGJTb3J0YWJsZUxpc3RdJyxcbiAgZXhwb3J0QXM6ICdtZGJTb3J0YWJsZUxpc3QnXG59KVxuZXhwb3J0IGNsYXNzIE1kYlNvcnRhYmxlTGlzdERpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcbiAgQENvbnRlbnRDaGlsZHJlbihNZGJTb3J0YWJsZURpcmVjdGl2ZSkgcHJpdmF0ZSBfc29ydGFibGVzOiBRdWVyeUxpc3Q8TWRiU29ydGFibGVEaXJlY3RpdmU+O1xuXG4gIEBJbnB1dCgpIGF1dG9TY3JvbGwgPSBmYWxzZTtcbiAgQElucHV0KCkgY29ubmVjdGVkV2l0aDogTWRiU29ydGFibGVMaXN0RGlyZWN0aXZlW107XG4gIEBJbnB1dCgpIGRhdGE6IGFueVtdO1xuICBAT3V0cHV0KCkgZHJvcCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgcHJpdmF0ZSBfcHJldmlvdXNMaXN0OiBhbnk7XG4gIHByaXZhdGUgX2N1cnJlbnRMaXN0OiBhbnk7XG4gIHByaXZhdGUgX2N1cnJlbnRJbmRleDogbnVtYmVyO1xuICBwcml2YXRlIF9uZXdJbmRleDogbnVtYmVyO1xuXG4gIHByaXZhdGUgX3Njcm9sbFNwZWVkID0gMTA7XG4gIHByaXZhdGUgX3Njcm9sbFNlbnNpdGl2aXR5ID0gMjA7XG5cbiAgY3VycmVudEluZGV4OiBudW1iZXI7XG4gIG5ld0luZGV4OiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIF9kb2N1bWVudDogYW55LFxuICAgIHByaXZhdGUgc29ydGFibGVTZXJ2aWNlOiBNZGJTb3J0YWJsZVNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge31cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgdGhpcy5fc29ydGFibGVzLmNoYW5nZXMuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICB0aGlzLl9zb3J0YWJsZXMgPSByZXN1bHQ7XG4gICAgfSk7XG5cbiAgICBjb25zdCBkcmFnID0gdGhpcy5zb3J0YWJsZVNlcnZpY2UuZHJhZ1N0YXJ0LnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX3NvcnRhYmxlcy50b0FycmF5KCkuZmluZChlbCA9PiBldmVudCA9PT0gZWwpKSB7XG4gICAgICAgICAgdGhpcy5fcHJldmlvdXNMaXN0ID0gdGhpcy5fY3VycmVudExpc3QgPSB0aGlzO1xuICAgICAgICAgIHRoaXMuX2N1cnJlbnRJbmRleCA9IHRoaXMuX3NvcnRhYmxlc1xuICAgICAgICAgICAgLnRvQXJyYXkoKVxuICAgICAgICAgICAgLmZpbmRJbmRleCgoZWw6IGFueSkgPT4gZXZlbnQgPT09IGVsKTtcbiAgICAgICAgICB0aGlzLl9uZXdJbmRleCA9IHRoaXMuX2N1cnJlbnRJbmRleDtcbiAgICAgICAgICByZXR1cm4gdGhpcy5zb3J0YWJsZVNlcnZpY2UuZHJhZ01vdmUucGlwZShcbiAgICAgICAgICAgIHRhcCgobW92ZUV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5vblNvcnQobW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbiwgbW92ZUV2ZW50LnBsYWNlaG9sZGVyLCBtb3ZlRXZlbnQuaGVscGVyKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgdGFrZVVudGlsKGRyb3ApXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JClcbiAgICApO1xuXG4gICAgY29uc3QgZHJvcCA9IHRoaXMuc29ydGFibGVTZXJ2aWNlLmRyYWdTdGFydC5waXBlKFxuICAgICAgc3dpdGNoTWFwKChldmVudDogYW55KSA9PiB7XG4gICAgICAgIGlmICh0aGlzLl9zb3J0YWJsZXMudG9BcnJheSgpLmZpbmQoZWwgPT4gZXZlbnQgPT09IGVsKSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnNvcnRhYmxlU2VydmljZS5kcmFnRW5kLnBpcGUoXG4gICAgICAgICAgICBmaXJzdCgpLFxuICAgICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5vbkRyYWdFbmQoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JClcbiAgICApO1xuXG4gICAgZHJhZy5zdWJzY3JpYmUoKTtcbiAgICBkcm9wLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc29ydEl0ZW1zKGRyYWdnZWQsIGhvdmVyZWQpIHtcbiAgICBjb25zdCBkcmFnZ2VkUGFyZW50ID0gZHJhZ2dlZC5wYXJlbnROb2RlO1xuICAgIGNvbnN0IGhvdmVyZWRQYXJlbnQgPSBob3ZlcmVkLnBhcmVudE5vZGU7XG5cbiAgICBpZiAoZHJhZ2dlZFBhcmVudCAhPT0gaG92ZXJlZFBhcmVudCkge1xuICAgICAgaG92ZXJlZFBhcmVudC5pbnNlcnRCZWZvcmUoZHJhZ2dlZCwgaG92ZXJlZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHRlbXAgPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIGRyYWdnZWRQYXJlbnQuaW5zZXJ0QmVmb3JlKHRlbXAsIGRyYWdnZWQpO1xuICAgICAgaG92ZXJlZFBhcmVudC5pbnNlcnRCZWZvcmUoZHJhZ2dlZCwgaG92ZXJlZCk7XG4gICAgICBkcmFnZ2VkUGFyZW50Lmluc2VydEJlZm9yZShob3ZlcmVkLCB0ZW1wKTtcbiAgICAgIGRyYWdnZWRQYXJlbnQucmVtb3ZlQ2hpbGQodGVtcCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlU2Nyb2xsUG9zKHNvcnRhYmxlRWxlbWVudDogSFRNTEVsZW1lbnQpIHtcbiAgICBjb25zdCBlbCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCBlbFJlY3QgPSBzb3J0YWJsZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICBjb25zdCBoZWlnaHQgPSBlbC5jbGllbnRIZWlnaHQ7XG4gICAgY29uc3Qgd2lkdGggPSBlbC5jbGllbnRXaWR0aDtcblxuXG4gICAgaWYgKGVsUmVjdC50b3AgPCB0aGlzLl9zY3JvbGxTZW5zaXRpdml0eSkge1xuICAgICAgZWwuc2Nyb2xsVG9wIC09IHRoaXMuX3Njcm9sbFNwZWVkO1xuICAgIH1cblxuICAgIGlmIChlbFJlY3QudG9wICsgZWxSZWN0LmhlaWdodCA+IGhlaWdodCAtIHRoaXMuX3Njcm9sbFNlbnNpdGl2aXR5KSB7XG4gICAgICBlbC5zY3JvbGxUb3AgKz0gdGhpcy5fc2Nyb2xsU3BlZWQ7XG4gICAgfVxuXG4gICAgaWYgKGVsUmVjdC5sZWZ0ICA8IHRoaXMuX3Njcm9sbFNlbnNpdGl2aXR5KSB7XG4gICAgICBlbC5zY3JvbGxMZWZ0IC09IHRoaXMuX3Njcm9sbFNwZWVkO1xuICAgIH1cblxuICAgIGlmIChlbFJlY3QubGVmdCArIGVsUmVjdC53aWR0aCA+IHdpZHRoIC0gdGhpcy5fc2Nyb2xsU2Vuc2l0aXZpdHkpIHtcbiAgICAgIGVsLnNjcm9sbExlZnQgKz0gdGhpcy5fc2Nyb2xsU3BlZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfaXNQb2ludGVyT3Zlckl0ZW0oaXRlbSwgeCwgeSkge1xuICAgIGNvbnN0IHsgdG9wLCBib3R0b20sIGxlZnQsIHJpZ2h0IH0gPSBpdGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIHJldHVybiB5ID49IHRvcCAmJiB5IDw9IGJvdHRvbSAmJiB4ID49IGxlZnQgJiYgeCA8PSByaWdodDtcbiAgfVxuXG4gIHByaXZhdGUgb25Tb3J0KHBvaW50ZXJQb3NpdGlvbjogYW55LCBwbGFjZWhvbGRlcjogSFRNTEVsZW1lbnQsIGhlbHBlcjogSFRNTEVsZW1lbnQpIHtcbiAgICBsZXQgbGlzdHM6IE1kYlNvcnRhYmxlTGlzdERpcmVjdGl2ZVtdO1xuICAgIGlmICh0aGlzLmNvbm5lY3RlZFdpdGgpIHtcbiAgICAgIGxpc3RzID0gdGhpcy5jb25uZWN0ZWRXaXRoLnNsaWNlKCk7XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnRJdGVtID0gcGxhY2Vob2xkZXI7XG4gICAgbGV0IGNvbnRhaW5lciA9IHRoaXMuX3NvcnRhYmxlcztcbiAgICB0aGlzLl9wcmV2aW91c0xpc3QgPSB0aGlzO1xuICAgIHRoaXMuX2N1cnJlbnRMaXN0ID0gdGhpcy5fcHJldmlvdXNMaXN0O1xuICAgIGxldCBhY3RpdmVMaXN0ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xuXG4gICAgaWYgKHRoaXMuYXV0b1Njcm9sbCkge1xuICAgICAgdGhpcy5fdXBkYXRlU2Nyb2xsUG9zKGhlbHBlcik7XG4gICAgfVxuXG4gICAgaWYgKGxpc3RzICYmIGxpc3RzLmxlbmd0aCkge1xuICAgICAgbGlzdHMuZm9yRWFjaChsaXN0ID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX2lzUG9pbnRlck92ZXJJdGVtKGxpc3QuZWwubmF0aXZlRWxlbWVudCwgcG9pbnRlclBvc2l0aW9uLngsIHBvaW50ZXJQb3NpdGlvbi55KSkge1xuICAgICAgICAgIGNvbnRhaW5lciA9IGxpc3QuX3NvcnRhYmxlcztcbiAgICAgICAgICBhY3RpdmVMaXN0ID0gbGlzdC5lbC5uYXRpdmVFbGVtZW50O1xuICAgICAgICAgIHRoaXMuX2N1cnJlbnRMaXN0ID0gbGlzdDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9pc1BvaW50ZXJPdmVySXRlbSh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsIHBvaW50ZXJQb3NpdGlvbi54LCBwb2ludGVyUG9zaXRpb24ueSkpIHtcbiAgICAgICAgICBjb250YWluZXIgPSB0aGlzLl9zb3J0YWJsZXM7XG4gICAgICAgICAgYWN0aXZlTGlzdCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICAgICAgICB0aGlzLl9jdXJyZW50TGlzdCA9IHRoaXMuX3ByZXZpb3VzTGlzdDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc29ydGFibGVzID0gY29udGFpbmVyO1xuXG4gICAgc29ydGFibGVzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpZiAodGhpcy5faXNQb2ludGVyT3Zlckl0ZW0oaXRlbS5lbC5uYXRpdmVFbGVtZW50LCBwb2ludGVyUG9zaXRpb24ueCwgcG9pbnRlclBvc2l0aW9uLnkpKSB7XG4gICAgICAgIHRoaXMuX3NvcnRJdGVtcyhjdXJyZW50SXRlbSwgaXRlbS5lbC5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgY29uc3QgbGlzdCA9IEFycmF5LmZyb20oYWN0aXZlTGlzdC5jaGlsZHJlbik7XG4gICAgICAgIHRoaXMuX25ld0luZGV4ID0gbGlzdC5maW5kSW5kZXgoKGVsOiBhbnkpID0+IGVsID09PSBjdXJyZW50SXRlbSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBvbkRyYWdFbmQoKSB7XG4gICAgdGhpcy5kcm9wLmVtaXQoe1xuICAgICAgY3VycmVudExpc3Q6IHRoaXMuX2N1cnJlbnRMaXN0LFxuICAgICAgcHJldmlvdXNMaXN0OiB0aGlzLl9wcmV2aW91c0xpc3QsXG4gICAgICBvbGRJbmRleDogdGhpcy5fY3VycmVudEluZGV4LFxuICAgICAgbmV3SW5kZXg6IHRoaXMuX25ld0luZGV4XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==