import { Directive, ElementRef, Renderer2, Input, Inject, EventEmitter, Output, HostBinding, } from '@angular/core';
import { fromEvent, merge, Subject } from 'rxjs';
import { takeUntil, tap, first, concatMap, filter } from 'rxjs/operators';
import { DOCUMENT } from '@angular/common';
import { MdbSortableService } from './mdb-sortable.service';
function cloneEl(node) {
    const clone = node.cloneNode(true);
    clone.removeAttribute('id');
    return clone;
}
export class MdbSortableDirective {
    constructor(el, renderer, _document, sortableService) {
        this.el = el;
        this.renderer = renderer;
        this._document = _document;
        this.sortableService = sortableService;
        this.disabled = false;
        this.sortThreshold = 5;
        this.dragStart = new EventEmitter();
        this.dragEnd = new EventEmitter();
        this.sortable = true;
        this._startPos = { x: 0, y: 0 };
        this._elPos = { x: 0, y: 0 };
        this._isDragging = false;
        this.destroy$ = new Subject();
    }
    _subscribeToEvents() {
        const drag = this.start$.pipe(filter((event) => event.button !== 2), concatMap((event) => {
            this.onDragStart(event);
            return this.move$.pipe(tap((moveEvent) => {
                this.onDragMove(moveEvent);
            }), takeUntil(this.end$));
        }), takeUntil(this.destroy$));
        const drop = this.start$.pipe(filter((event) => event.button !== 2), concatMap((event) => {
            return this.end$.pipe(first(), tap(() => {
                this.onDragEnd(event);
            }));
        }), takeUntil(this.destroy$));
        drag.subscribe();
        drop.subscribe();
    }
    _createPlaceholder() {
        const placeholder = cloneEl(this.el.nativeElement);
        this.renderer.addClass(placeholder, 'mdb-sortable-placeholder');
        return placeholder;
    }
    _createHelper() {
        const helper = cloneEl(this.el.nativeElement);
        this.renderer.setStyle(helper, 'position', 'fixed');
        this.renderer.setStyle(helper, 'top', '0');
        this.renderer.setStyle(helper, 'left', '0');
        this.renderer.setStyle(helper, 'width', `${this._elRect.width}px`);
        this.renderer.setStyle(helper, 'height', `${this._elRect.height}px`);
        this.renderer.setStyle(helper, 'transform', this._getTransform(this._elRect.left, this._elRect.top));
        this.renderer.addClass(helper, 'mdb-sortable-helper');
        return helper;
    }
    _initSortableElements() {
        const el = this.el.nativeElement;
        const placeholder = this._placeholder = this._createPlaceholder();
        const helper = this._helper = this._createHelper();
        this.renderer.appendChild(this._document.body, el.parentNode.replaceChild(placeholder, el));
        this.renderer.appendChild(this._document.body, helper);
        this.renderer.setStyle(el, 'display', 'none');
    }
    onDragStart(event) {
        this.activeEl = event.target;
        if (this.disabledDragElements && this.disabledDragElements.find((el) => el === event.target)) {
            return false;
        }
        else {
            event.stopPropagation();
            if (this.disabled) {
                return;
            }
            if (event instanceof MouseEvent && event.button === 2) {
                return;
            }
            const elRect = this._elRect = this.el.nativeElement.getBoundingClientRect();
            this._pickUpPos = this._getPointerPos(event);
            this._startPos.x = elRect.left;
            this._startPos.y = elRect.top;
            this.dragStart.emit(this);
            this.sortableService.dragStart.next(this);
        }
    }
    onDragMove(event) {
        this.activeEl = event.target;
        if (this.disabledDragElements && this.disabledDragElements.find((el) => el === event.target)) {
            return false;
        }
        else {
            if (this.disabled) {
                return;
            }
            const pointerPosition = this._getPointerPos(event);
            const diffX = Math.abs(pointerPosition.x - this._pickUpPos.x);
            const diffY = Math.abs(pointerPosition.y - this._pickUpPos.y);
            const isOverThreshold = diffX + diffY >= this.sortThreshold;
            // event.preventDefault();
            if (this._pickUpPos && isOverThreshold) {
                if (!this._isDragging) {
                    this._isDragging = true;
                    this._initSortableElements();
                }
                this._elPos.x = pointerPosition.x - this._pickUpPos.x + this._startPos.x;
                this._elPos.y = pointerPosition.y - this._pickUpPos.y + this._startPos.y;
                this._helper.style.transform = this._getTransform(this._elPos.x, this._elPos.y);
                this.sortableService.dragMove.next({
                    pointerPosition: pointerPosition,
                    placeholder: this._placeholder,
                    helper: this._helper
                });
            }
        }
    }
    onDragEnd(event) {
        if (this.disabledDragElements && this.disabledDragElements.find((el) => el === event.target)) {
            return false;
        }
        else {
            if (this.disabled) {
                return;
            }
            if (this._isDragging) {
                this.renderer.removeStyle(this.el.nativeElement, 'transform');
                if (this._helper) {
                    this.renderer.removeChild(this._document.body, this._helper);
                }
                if (this._placeholder) {
                    this.renderer
                        .appendChild(this._document.body, this._placeholder.parentNode.replaceChild(this.el.nativeElement, this._placeholder));
                }
                this.renderer.removeStyle(this.el.nativeElement, 'display');
                if (this._placeholder && this._placeholder.parentNode) {
                    this.renderer.removeChild(this._placeholder.parentNode, this._placeholder);
                }
            }
            this.dragEnd.emit();
            this.sortableService.dragEnd.next(this);
            this.activeEl = null;
            this._isDragging = false;
        }
    }
    _getDocumentScrollPos() {
        const documentElement = this._document.documentElement;
        const body = this._document.body;
        const top = documentElement.scrollTop || body.scrollTop;
        const left = documentElement.scrollLeft || body.scrollLeft;
        return { top, left };
    }
    _getPointerPos(event) {
        const point = this._isTouchEvent(event) ? (event.touches[0] || event.changedTouches[0]) : event;
        const scrollPos = this._getDocumentScrollPos();
        return {
            x: point.pageX - scrollPos.left,
            y: point.pageY - scrollPos.top
        };
    }
    _isTouchEvent(event) {
        return event.type.startsWith('touch');
    }
    _getTransform(x, y) {
        return `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
    }
    ngOnInit() {
        this.start$ = merge(fromEvent(this.el.nativeElement, 'mousedown', { passive: false }), fromEvent(this.el.nativeElement, 'touchstart', { passive: false }));
        this.move$ = merge(fromEvent(this._document, 'mousemove', { passive: false }), fromEvent(this._document, 'touchmove', { passive: false }));
        this.end$ = merge(fromEvent(this._document, 'mouseup', { passive: false }), fromEvent(this._document, 'touchend', { passive: false }));
        this._subscribeToEvents();
        this._elRect = this.el.nativeElement.getBoundingClientRect();
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
}
MdbSortableDirective.decorators = [
    { type: Directive, args: [{
                selector: '[mdbSortable]'
            },] }
];
MdbSortableDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: MdbSortableService }
];
MdbSortableDirective.propDecorators = {
    disabled: [{ type: HostBinding, args: ['class.mdb-sortable-disabled',] }, { type: Input }],
    disabledDragElements: [{ type: Input }],
    sortThreshold: [{ type: Input }],
    dragStart: [{ type: Output }],
    dragEnd: [{ type: Output }],
    sortable: [{ type: HostBinding, args: ['class.mdb-sortable',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLXNvcnRhYmxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL21kYi1zb3J0YWJsZS9zcmMvbGliL21kYi1zb3J0YWJsZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsU0FBUyxFQUdULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLE1BQU0sRUFDTixXQUFXLEdBQ1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFhLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sRUFBQyxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLHdCQUF3QixDQUFDO0FBYzFELFNBQVMsT0FBTyxDQUFDLElBQWlCO0lBQ2hDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFnQixDQUFDO0lBQ2xELEtBQUssQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBS0QsTUFBTSxPQUFPLG9CQUFvQjtJQTJCL0IsWUFDUyxFQUFjLEVBQ2IsUUFBbUIsRUFDRCxTQUFjLEVBQ2hDLGVBQW1DO1FBSHBDLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDYixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ0QsY0FBUyxHQUFULFNBQVMsQ0FBSztRQUNoQyxvQkFBZSxHQUFmLGVBQWUsQ0FBb0I7UUE3QnBDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFFakIsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFD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O1FBRUYsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQy9ELENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzNCLENBQUM7OztZQTFQRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGVBQWU7YUFDMUI7OztZQW5DQyxVQUFVO1lBQ1YsU0FBUzs0Q0FpRU4sTUFBTSxTQUFDLFFBQVE7WUFyRFosa0JBQWtCOzs7dUJBd0J2QixXQUFXLFNBQUMsNkJBQTZCLGNBQ3pDLEtBQUs7bUNBQ0wsS0FBSzs0QkFDTCxLQUFLO3dCQUNMLE1BQU07c0JBQ04sTUFBTTt1QkFFTixXQUFXLFNBQUMsb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBSZW5kZXJlcjIsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95LFxuICBJbnB1dCxcbiAgSW5qZWN0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dCxcbiAgSG9zdEJpbmRpbmcsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtmcm9tRXZlbnQsIG1lcmdlLCBTdWJqZWN0LCBPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7dGFrZVVudGlsLCB0YXAsIGZpcnN0LCBjb25jYXRNYXAsIGZpbHRlcn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtNZGJTb3J0YWJsZVNlcnZpY2V9IGZyb20gJy4vbWRiLXNvcnRhYmxlLnNlcnZpY2UnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFBvc2l0aW9uIHtcbiAgeDogbnVtYmVyO1xuICB5OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQm91bmRhcmllcyB7XG4gIG1pblg6IG51bWJlcjtcbiAgbWF4WDogbnVtYmVyO1xuICBtaW5ZOiBudW1iZXI7XG4gIG1heFk6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gY2xvbmVFbChub2RlOiBIVE1MRWxlbWVudCk6IEhUTUxFbGVtZW50IHtcbiAgY29uc3QgY2xvbmUgPSBub2RlLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudDtcbiAgY2xvbmUucmVtb3ZlQXR0cmlidXRlKCdpZCcpO1xuICByZXR1cm4gY2xvbmU7XG59XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1ttZGJTb3J0YWJsZV0nXG59KVxuZXhwb3J0IGNsYXNzIE1kYlNvcnRhYmxlRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBASG9zdEJpbmRpbmcoJ2NsYXNzLm1kYi1zb3J0YWJsZS1kaXNhYmxlZCcpXG4gIEBJbnB1dCgpIGRpc2FibGVkID0gZmFsc2U7XG4gIEBJbnB1dCgpIGRpc2FibGVkRHJhZ0VsZW1lbnRzOiBFbGVtZW50UmVmW107XG4gIEBJbnB1dCgpIHNvcnRUaHJlc2hvbGQgPSA1O1xuICBAT3V0cHV0KCkgZHJhZ1N0YXJ0ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBkcmFnRW5kID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5tZGItc29ydGFibGUnKSBzb3J0YWJsZSA9IHRydWU7XG5cbiAgcHVibGljIF9oZWxwZXI6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIF9lbFJlY3Q6IENsaWVudFJlY3Q7XG4gIHB1YmxpYyBfcGxhY2Vob2xkZXI6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIF9waWNrVXBQb3M6IFBvc2l0aW9uO1xuICBwcml2YXRlIF9zdGFydFBvczogUG9zaXRpb24gPSB7eDogMCwgeTogMH07XG4gIHB1YmxpYyBfZWxQb3M6IFBvc2l0aW9uID0ge3g6IDAsIHk6IDB9O1xuXG4gIHByaXZhdGUgYWN0aXZlRWw6IGFueTtcblxuICBzdGFydCQ6IE9ic2VydmFibGU8YW55PjtcbiAgbW92ZSQ6IE9ic2VydmFibGU8YW55PjtcbiAgZW5kJDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gIHByaXZhdGUgX2lzRHJhZ2dpbmcgPSBmYWxzZTtcblxuICBwcml2YXRlIGRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBlbDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBfZG9jdW1lbnQ6IGFueSxcbiAgICBwcml2YXRlIHNvcnRhYmxlU2VydmljZTogTWRiU29ydGFibGVTZXJ2aWNlXG4gICkge1xuICB9XG5cbiAgcHJpdmF0ZSBfc3Vic2NyaWJlVG9FdmVudHMoKSB7XG4gICAgY29uc3QgZHJhZyA9IHRoaXMuc3RhcnQkLnBpcGUoXG4gICAgICBmaWx0ZXIoKGV2ZW50OiBhbnkpID0+IGV2ZW50LmJ1dHRvbiAhPT0gMiksXG4gICAgICBjb25jYXRNYXAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5vbkRyYWdTdGFydChldmVudCk7XG4gICAgICAgIHJldHVybiB0aGlzLm1vdmUkLnBpcGUoXG4gICAgICAgICAgdGFwKChtb3ZlRXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vbkRyYWdNb3ZlKG1vdmVFdmVudCk7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuZW5kJClcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpXG4gICAgKTtcblxuICAgIGNvbnN0IGRyb3AgPSB0aGlzLnN0YXJ0JC5waXBlKFxuICAgICAgZmlsdGVyKChldmVudDogYW55KSA9PiBldmVudC5idXR0b24gIT09IDIpLFxuICAgICAgY29uY2F0TWFwKChldmVudDogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmVuZCQucGlwZShcbiAgICAgICAgICBmaXJzdCgpLFxuICAgICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9uRHJhZ0VuZChldmVudCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpXG4gICAgKTtcblxuICAgIGRyYWcuc3Vic2NyaWJlKCk7XG4gICAgZHJvcC5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NyZWF0ZVBsYWNlaG9sZGVyKCk6IEhUTUxFbGVtZW50IHtcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IGNsb25lRWwodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHBsYWNlaG9sZGVyLCAnbWRiLXNvcnRhYmxlLXBsYWNlaG9sZGVyJyk7XG4gICAgcmV0dXJuIHBsYWNlaG9sZGVyO1xuICB9XG5cbiAgcHJpdmF0ZSBfY3JlYXRlSGVscGVyKCk6IEhUTUxFbGVtZW50IHtcblxuICAgIGNvbnN0IGhlbHBlciA9IGNsb25lRWwodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcblxuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoaGVscGVyLCAncG9zaXRpb24nLCAnZml4ZWQnKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKGhlbHBlciwgJ3RvcCcsICcwJyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShoZWxwZXIsICdsZWZ0JywgJzAnKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKGhlbHBlciwgJ3dpZHRoJywgYCR7dGhpcy5fZWxSZWN0LndpZHRofXB4YCk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShoZWxwZXIsICdoZWlnaHQnLCBgJHt0aGlzLl9lbFJlY3QuaGVpZ2h0fXB4YCk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShoZWxwZXIsICd0cmFuc2Zvcm0nLCB0aGlzLl9nZXRUcmFuc2Zvcm0odGhpcy5fZWxSZWN0LmxlZnQsIHRoaXMuX2VsUmVjdC50b3ApKTtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKGhlbHBlciwgJ21kYi1zb3J0YWJsZS1oZWxwZXInKTtcblxuICAgIHJldHVybiBoZWxwZXI7XG4gIH1cblxuICBwcml2YXRlIF9pbml0U29ydGFibGVFbGVtZW50cygpIHtcbiAgICBjb25zdCBlbCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IHRoaXMuX3BsYWNlaG9sZGVyID0gdGhpcy5fY3JlYXRlUGxhY2Vob2xkZXIoKTtcbiAgICBjb25zdCBoZWxwZXIgPSB0aGlzLl9oZWxwZXIgPSB0aGlzLl9jcmVhdGVIZWxwZXIoKTtcblxuICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5fZG9jdW1lbnQuYm9keSwgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQocGxhY2Vob2xkZXIsIGVsKSk7XG4gICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLl9kb2N1bWVudC5ib2R5LCBoZWxwZXIpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoZWwsICdkaXNwbGF5JywgJ25vbmUnKTtcbiAgfVxuXG4gIG9uRHJhZ1N0YXJ0KGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLmFjdGl2ZUVsID0gZXZlbnQudGFyZ2V0O1xuICAgIGlmICh0aGlzLmRpc2FibGVkRHJhZ0VsZW1lbnRzICYmIHRoaXMuZGlzYWJsZWREcmFnRWxlbWVudHMuZmluZCgoZWw6IGFueSkgPT4gZWwgPT09IGV2ZW50LnRhcmdldCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgTW91c2VFdmVudCAmJiBldmVudC5idXR0b24gPT09IDIpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG5cbiAgICAgIGNvbnN0IGVsUmVjdCA9IHRoaXMuX2VsUmVjdCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgdGhpcy5fcGlja1VwUG9zID0gdGhpcy5fZ2V0UG9pbnRlclBvcyhldmVudCk7XG5cbiAgICAgIHRoaXMuX3N0YXJ0UG9zLnggPSBlbFJlY3QubGVmdDtcbiAgICAgIHRoaXMuX3N0YXJ0UG9zLnkgPSBlbFJlY3QudG9wO1xuXG4gICAgICB0aGlzLmRyYWdTdGFydC5lbWl0KHRoaXMpO1xuXG4gICAgICB0aGlzLnNvcnRhYmxlU2VydmljZS5kcmFnU3RhcnQubmV4dCh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBvbkRyYWdNb3ZlKGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLmFjdGl2ZUVsID0gZXZlbnQudGFyZ2V0O1xuICAgIGlmICh0aGlzLmRpc2FibGVkRHJhZ0VsZW1lbnRzICYmIHRoaXMuZGlzYWJsZWREcmFnRWxlbWVudHMuZmluZCgoZWw6IGFueSkgPT4gZWwgPT09IGV2ZW50LnRhcmdldCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgcG9pbnRlclBvc2l0aW9uID0gdGhpcy5fZ2V0UG9pbnRlclBvcyhldmVudCk7XG4gICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKHBvaW50ZXJQb3NpdGlvbi54IC0gdGhpcy5fcGlja1VwUG9zLngpO1xuICAgICAgY29uc3QgZGlmZlkgPSBNYXRoLmFicyhwb2ludGVyUG9zaXRpb24ueSAtIHRoaXMuX3BpY2tVcFBvcy55KTtcbiAgICAgIGNvbnN0IGlzT3ZlclRocmVzaG9sZCA9IGRpZmZYICsgZGlmZlkgPj0gdGhpcy5zb3J0VGhyZXNob2xkO1xuXG4gICAgICAvLyBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICBpZiAodGhpcy5fcGlja1VwUG9zICYmIGlzT3ZlclRocmVzaG9sZCkge1xuICAgICAgICBpZiAoIXRoaXMuX2lzRHJhZ2dpbmcpIHtcbiAgICAgICAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLl9pbml0U29ydGFibGVFbGVtZW50cygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2VsUG9zLnggPSBwb2ludGVyUG9zaXRpb24ueCAtIHRoaXMuX3BpY2tVcFBvcy54ICsgdGhpcy5fc3RhcnRQb3MueDtcbiAgICAgICAgdGhpcy5fZWxQb3MueSA9IHBvaW50ZXJQb3NpdGlvbi55IC0gdGhpcy5fcGlja1VwUG9zLnkgKyB0aGlzLl9zdGFydFBvcy55O1xuXG4gICAgICAgIHRoaXMuX2hlbHBlci5zdHlsZS50cmFuc2Zvcm0gPSB0aGlzLl9nZXRUcmFuc2Zvcm0odGhpcy5fZWxQb3MueCwgdGhpcy5fZWxQb3MueSk7XG5cbiAgICAgICAgdGhpcy5zb3J0YWJsZVNlcnZpY2UuZHJhZ01vdmUubmV4dCh7XG4gICAgICAgICAgcG9pbnRlclBvc2l0aW9uOiBwb2ludGVyUG9zaXRpb24sXG4gICAgICAgICAgcGxhY2Vob2xkZXI6IHRoaXMuX3BsYWNlaG9sZGVyLFxuICAgICAgICAgIGhlbHBlcjogdGhpcy5faGVscGVyXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG9uRHJhZ0VuZChldmVudDogYW55KSB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWREcmFnRWxlbWVudHMgJiYgdGhpcy5kaXNhYmxlZERyYWdFbGVtZW50cy5maW5kKChlbDogYW55KSA9PiBlbCA9PT0gZXZlbnQudGFyZ2V0KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLl9pc0RyYWdnaW5nKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlU3R5bGUodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAndHJhbnNmb3JtJyk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2hlbHBlcikge1xuICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2hpbGQodGhpcy5fZG9jdW1lbnQuYm9keSwgdGhpcy5faGVscGVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9wbGFjZWhvbGRlcikge1xuICAgICAgICAgIHRoaXMucmVuZGVyZXJcbiAgICAgICAgICAuYXBwZW5kQ2hpbGQodGhpcy5fZG9jdW1lbnQuYm9keSwgdGhpcy5fcGxhY2Vob2xkZXIucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy5lbC5uYXRpdmVFbGVtZW50LCB0aGlzLl9wbGFjZWhvbGRlcikpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlU3R5bGUodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnZGlzcGxheScpO1xuXG4gICAgICAgIGlmICh0aGlzLl9wbGFjZWhvbGRlciAmJiB0aGlzLl9wbGFjZWhvbGRlci5wYXJlbnROb2RlKSB7XG4gICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLl9wbGFjZWhvbGRlci5wYXJlbnROb2RlLCB0aGlzLl9wbGFjZWhvbGRlcik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuXG4gICAgICB0aGlzLmRyYWdFbmQuZW1pdCgpO1xuICAgICAgdGhpcy5zb3J0YWJsZVNlcnZpY2UuZHJhZ0VuZC5uZXh0KHRoaXMpO1xuXG4gICAgICB0aGlzLmFjdGl2ZUVsID0gbnVsbDtcbiAgICAgIHRoaXMuX2lzRHJhZ2dpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9nZXREb2N1bWVudFNjcm9sbFBvcygpIHtcbiAgICBjb25zdCBkb2N1bWVudEVsZW1lbnQgPSB0aGlzLl9kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG4gICAgY29uc3QgYm9keSA9IHRoaXMuX2RvY3VtZW50LmJvZHk7XG5cbiAgICBjb25zdCB0b3AgPSBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIHx8IGJvZHkuc2Nyb2xsVG9wO1xuICAgIGNvbnN0IGxlZnQgPSBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCB8fCBib2R5LnNjcm9sbExlZnQ7XG5cbiAgICByZXR1cm4ge3RvcCwgbGVmdH07XG4gIH1cblxuICBwcml2YXRlIF9nZXRQb2ludGVyUG9zKGV2ZW50OiBNb3VzZUV2ZW50KTogUG9zaXRpb24ge1xuICAgIGNvbnN0IHBvaW50ID0gdGhpcy5faXNUb3VjaEV2ZW50KGV2ZW50KSA/IChldmVudC50b3VjaGVzWzBdIHx8IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdKSA6IGV2ZW50O1xuICAgIGNvbnN0IHNjcm9sbFBvcyA9IHRoaXMuX2dldERvY3VtZW50U2Nyb2xsUG9zKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgeDogcG9pbnQucGFnZVggLSBzY3JvbGxQb3MubGVmdCxcbiAgICAgIHk6IHBvaW50LnBhZ2VZIC0gc2Nyb2xsUG9zLnRvcFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIF9pc1RvdWNoRXZlbnQoZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KTogZXZlbnQgaXMgVG91Y2hFdmVudCB7XG4gICAgcmV0dXJuIGV2ZW50LnR5cGUuc3RhcnRzV2l0aCgndG91Y2gnKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFRyYW5zZm9ybSh4OiBudW1iZXIsIHk6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGB0cmFuc2xhdGUzZCgke01hdGgucm91bmQoeCl9cHgsICR7TWF0aC5yb3VuZCh5KX1weCwgMClgO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5zdGFydCQgPSBtZXJnZShcbiAgICAgIGZyb21FdmVudCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdtb3VzZWRvd24nLCB7cGFzc2l2ZTogZmFsc2V9KSxcbiAgICAgIGZyb21FdmVudCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICd0b3VjaHN0YXJ0Jywge3Bhc3NpdmU6IGZhbHNlfSlcbiAgICApO1xuXG4gICAgdGhpcy5tb3ZlJCA9IG1lcmdlKFxuICAgICAgZnJvbUV2ZW50KHRoaXMuX2RvY3VtZW50LCAnbW91c2Vtb3ZlJywge3Bhc3NpdmU6IGZhbHNlfSksXG4gICAgICBmcm9tRXZlbnQodGhpcy5fZG9jdW1lbnQsICd0b3VjaG1vdmUnLCB7cGFzc2l2ZTogZmFsc2V9KVxuICAgICk7XG5cbiAgICB0aGlzLmVuZCQgPSBtZXJnZShcbiAgICAgIGZyb21FdmVudCh0aGlzLl9kb2N1bWVudCwgJ21vdXNldXAnLCB7cGFzc2l2ZTogZmFsc2V9KSxcbiAgICAgIGZyb21FdmVudCh0aGlzLl9kb2N1bWVudCwgJ3RvdWNoZW5kJywge3Bhc3NpdmU6IGZhbHNlfSksXG4gICAgKTtcblxuICAgIHRoaXMuX3N1YnNjcmliZVRvRXZlbnRzKCk7XG4gICAgdGhpcy5fZWxSZWN0ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG59XG4iXX0=