import { Directive, ElementRef, EventEmitter, Input, Output, Renderer2, NgZone, } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged } from 'rxjs/operators';
export class MdbTableEditorDirective {
    constructor(renderer, el, ngZone) {
        this.renderer = renderer;
        this.el = el;
        this.ngZone = ngZone;
        this.itemsPerPage = 10;
        this.rowHighlight = new EventEmitter();
        this.highlightedTableRow = null;
        this.dataArrayUnmodified = [];
        this.currentPage = 1;
        this.nextShouldBeDisabled = false;
        this.data = [];
        this.isDesc = true;
        this._searchKey = '';
        this._dataArray$ = new Subject();
        this._iterableDataArray = [];
        this._iterableDataArray$ = new Subject();
        this.paginationInfo = {
            firstItem: 1,
            lastItem: this.itemsPerPage,
            allItems: this.dataArrayUnmodified.length,
            activePage: this.currentPage,
        };
        this.dataArrayChange()
            .pipe()
            .subscribe((newData) => {
            this.dataArrayUnmodified = newData;
            setTimeout(() => {
                this.iterableDataArray = this.dataArrayUnmodified.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
                this.data = this.iterableDataArray;
                this.updatePaginationInfo();
            }, 0);
        });
        this.iterableDataArrayChange()
            .pipe(distinctUntilChanged())
            .subscribe(() => {
            if (this.data && this._searchKey.length == 0 && this.currentPage == 1) {
                this.paginationInfo.firstItem = this.data.findIndex((el) => el === this.data[0]) + 1;
                this.paginationInfo.lastItem =
                    this.data.findIndex((el) => el == this.data[this.data.length - 1]) + 1;
            }
            if (this.iterableDataArray &&
                this.iterableDataArray.findIndex((el) => el == this.highlightedTableRow) === -1) {
                if (this.highlightedTableRow !== null) {
                    this.highlightedTableRow = null;
                    this.rowHighlight.emit(null);
                }
            }
        });
        const click$ = fromEvent(this.el.nativeElement, 'click');
        click$.subscribe((event) => {
            // Workaround for situation when fromEvent is not able to emit value from EventEmitter
            this.ngZone.run(() => {
                this.markHighlightAndEmit(event);
            });
        });
    }
    set dataArray(data) {
        this._dataArray = data;
        this._dataArray$.next(this.dataArray);
    }
    get dataArray() {
        return this._dataArray;
    }
    dataArrayChange() {
        return this._dataArray$;
    }
    set iterableDataArray(data) {
        this._iterableDataArray = data;
        this._iterableDataArray$.next(this.iterableDataArray);
    }
    get iterableDataArray() {
        return this._iterableDataArray;
    }
    iterableDataArrayChange() {
        return this._iterableDataArray$;
    }
    ngOnChanges(changes) {
        if (changes['itemsPerPage']) {
            this.iterableDataArray = this.dataArrayUnmodified.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
            if (!changes['itemsPerPage'].isFirstChange()) {
                this.updatePaginationInfo();
            }
        }
    }
    calculatePagesNumber() {
        return Math.ceil(this.dataArrayUnmodified.length / this.itemsPerPage);
    }
    updatePaginationInfo() {
        if (this.dataArray) {
            const firstAndLastIndexes = {
                first: this.dataArray.findIndex((el) => el === this.iterableDataArray[0]) + 1 ||
                    this.iterableDataArray.findIndex((el) => el === this.iterableDataArray[0]) + 1,
                last: this.dataArray.findIndex((el) => el === this.iterableDataArray[this.iterableDataArray.length - 1]) + 1 ||
                    this.iterableDataArray.findIndex((el) => el === this.iterableDataArray[this.iterableDataArray.length - 1]) + 1,
            };
            this.paginationInfo = {
                firstItem: firstAndLastIndexes.first,
                lastItem: firstAndLastIndexes.last,
                allItems: this.dataArrayUnmodified.length,
                activePage: this.currentPage,
            };
        }
    }
    nextPage(switchToLastPage) {
        if (this.currentPage < this.calculatePagesNumber()) {
            if (switchToLastPage) {
                this.currentPage = this.calculatePagesNumber();
            }
            else {
                this.currentPage++;
            }
            this.iterableDataArray = this.dataArrayUnmodified.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
            this.updatePaginationInfo();
            const firstAndLastIndexes = {
                first: this.dataArrayUnmodified.findIndex((el) => el == this.iterableDataArray[0]) + 1,
                last: this.dataArrayUnmodified.findIndex((el) => el == this.iterableDataArray[this.iterableDataArray.length - 1]) + 1,
            };
            this.paginationInfo.firstItem = firstAndLastIndexes.first;
            this.paginationInfo.lastItem = firstAndLastIndexes.last;
        }
    }
    prevPage(switchToFirstPage) {
        if (this.currentPage > 1) {
            if (switchToFirstPage) {
                this.currentPage = 1;
            }
            else {
                this.currentPage--;
            }
            this.iterableDataArray = this.dataArrayUnmodified.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
            this.updatePaginationInfo();
        }
        const firstAndLastIndexes = {
            first: this.dataArrayUnmodified.findIndex((el) => el == this.iterableDataArray[0]) + 1,
            last: this.dataArrayUnmodified.findIndex((el) => el == this.iterableDataArray[this.iterableDataArray.length - 1]) + 1,
        };
        this.paginationInfo.firstItem = firstAndLastIndexes.first;
        this.paginationInfo.lastItem = firstAndLastIndexes.last;
    }
    disablePrevious() {
        return this.currentPage === 1;
    }
    disableNext() {
        if (this.dataArrayUnmodified) {
            return this.currentPage >= this.calculatePagesNumber() || this.nextShouldBeDisabled;
        }
    }
    filterIterableArray(searchKey) {
        if (this.dataArray) {
            const filter = this.dataArray.filter((obj) => {
                return Object.keys(obj).some((key) => {
                    if (obj[key] !== null) {
                        return obj[key]
                            .toString()
                            .toLowerCase()
                            .includes(searchKey);
                    }
                });
            });
            this.iterableDataArray = filter.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
            this.nextShouldBeDisabled = this.iterableDataArray.length < this.itemsPerPage;
            this.updatePaginationInfo();
            return this.iterableDataArray;
        }
    }
    performSearch(searchKey) {
        this._searchKey = searchKey;
        if (!searchKey && this.dataArray) {
            this.nextShouldBeDisabled = false;
            this.data = this.dataArray.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
            this._iterableDataArray$.next(this.data);
            return this.dataArray.slice(this.itemsPerPage * (this.currentPage - 1), this.itemsPerPage * (this.currentPage - 1) + this.itemsPerPage);
        }
        else {
            this.data = this.filterIterableArray(searchKey.toLowerCase());
            return this.filterIterableArray(searchKey.toLowerCase());
        }
    }
    sortArray(property) {
        this.dataArray = this.dataArrayUnmodified.slice();
        this.isDesc = !this.isDesc; //change the direction
        property = property.replace(/ /g, '_').toLowerCase();
        const direction = this.isDesc ? 1 : -1;
        this.dataArray.sort((a, b) => {
            if (a[property] < b[property]) {
                return -1 * direction;
            }
            else if (a[property] > b[property]) {
                return 1 * direction;
            }
            else {
                return 0;
            }
        });
    }
    _getClosestEl(el, selector) {
        for (; el && el !== document; el = el.parentNode) {
            if (el.matches && el.matches(selector)) {
                return el;
            }
        }
        return null;
    }
    markHighlightAndEmit(event) {
        const tableRow = this._getClosestEl(event.target, 'tr');
        const tbody = this._getClosestEl(event.target, 'tbody');
        if (tbody && event.target) {
            tbody.childNodes.forEach((row, index) => {
                if (row === tableRow) {
                    this.highlightedTableRow = this.iterableDataArray[index];
                }
                if (row !== tableRow) {
                    if (row.classList && row.classList.contains('tr-color-selected')) {
                        this.renderer.removeClass(row, 'tr-color-selected');
                    }
                }
            });
            this.rowHighlight.emit(this.highlightedTableRow);
            this.renderer.addClass(tableRow, 'tr-color-selected');
        }
    }
}
MdbTableEditorDirective.decorators = [
    { type: Directive, args: [{
                selector: '[mdbTableEditor]',
                exportAs: 'mdbEditor',
            },] }
];
MdbTableEditorDirective.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: NgZone }
];
MdbTableEditorDirective.propDecorators = {
    itemsPerPage: [{ type: Input }],
    rowHighlight: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLXRhYmxlLWVkaXRvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9tZGItdGFibGUtZWRpdG9yL3NyYy9saWIvbWRiLXRhYmxlLWVkaXRvci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBQ04sU0FBUyxFQUVULE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQU10RCxNQUFNLE9BQU8sdUJBQXVCO0lBeURsQyxZQUFvQixRQUFtQixFQUFVLEVBQWMsRUFBVSxNQUFjO1FBQW5FLGFBQVEsR0FBUixRQUFRLENBQVc7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQXhEOUUsaUJBQVksR0FBRyxFQUFFLENBQUM7UUFDakIsaUJBQVksR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUU1RCx3QkFBbUIsR0FBUSxJQUFJLENBQUM7UUFDaEMsd0JBQW1CLEdBQVUsRUFBRSxDQUFDO1FBRWhDLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLHlCQUFvQixHQUFHLEtBQUssQ0FBQztRQUM3QixTQUFJLEdBQVEsRUFBRSxDQUFDO1FBQ2YsV0FBTSxHQUFHLElBQUksQ0FBQztRQUNkLGVBQVUsR0FBRyxFQUFFLENBQUM7UUFHaEIsZ0JBQVcsR0FBbUIsSUFBSSxPQUFPLEVBQVMsQ0FBQztRQUVuRCx1QkFBa0IsR0FBVSxFQUFFLENBQUM7UUFDL0Isd0JBQW1CLEdBQW1CLElBQUksT0FBTyxFQUFTLENBQUM7UUFFNUQsbUJBQWMsR0FLakI7WUFDRixTQUFT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SyxDQUFDLE1BQU0sRUFBRTtZQUN6QixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVEsRUFBRSxLQUFhLEVBQUUsRUFBRTtnQkFDbkQsSUFBSSxHQUFHLEtBQUssUUFBUSxFQUFFO29CQUNwQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUMxRDtnQkFFRCxJQUFJLEdBQUcsS0FBSyxRQUFRLEVBQUU7b0JBQ3BCLElBQUksR0FBRyxDQUFDLFNBQVMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO3dCQUNoRSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztxQkFDckQ7aUJBQ0Y7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1NBQ3ZEO0lBQ0gsQ0FBQzs7O1lBdFNGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsa0JBQWtCO2dCQUM1QixRQUFRLEVBQUUsV0FBVzthQUN0Qjs7O1lBVkMsU0FBUztZQUxULFVBQVU7WUFPVixNQUFNOzs7MkJBVUwsS0FBSzsyQkFDTCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE91dHB1dCxcbiAgUmVuZGVyZXIyLFxuICBTaW1wbGVDaGFuZ2VzLFxuICBOZ1pvbmUsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW21kYlRhYmxlRWRpdG9yXScsXG4gIGV4cG9ydEFzOiAnbWRiRWRpdG9yJyxcbn0pXG5leHBvcnQgY2xhc3MgTWRiVGFibGVFZGl0b3JEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICBASW5wdXQoKSBpdGVtc1BlclBhZ2UgPSAxMDtcbiAgQE91dHB1dCgpIHJvd0hpZ2hsaWdodDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBwcml2YXRlIGhpZ2hsaWdodGVkVGFibGVSb3c6IGFueSA9IG51bGw7XG4gIHByaXZhdGUgZGF0YUFycmF5VW5tb2RpZmllZDogYW55W10gPSBbXTtcblxuICBwcml2YXRlIGN1cnJlbnRQYWdlID0gMTtcbiAgcHJpdmF0ZSBuZXh0U2hvdWxkQmVEaXNhYmxlZCA9IGZhbHNlO1xuICBwcml2YXRlIGRhdGE6IGFueSA9IFtdO1xuICBwcml2YXRlIGlzRGVzYyA9IHRydWU7XG4gIHByaXZhdGUgX3NlYXJjaEtleSA9ICcnO1xuXG4gIHByaXZhdGUgX2RhdGFBcnJheTogYW55W107XG4gIHByaXZhdGUgX2RhdGFBcnJheSQ6IFN1YmplY3Q8YW55W10+ID0gbmV3IFN1YmplY3Q8YW55W10+KCk7XG5cbiAgcHJpdmF0ZSBfaXRlcmFibGVEYXRhQXJyYXk6IGFueVtdID0gW107XG4gIHByaXZhdGUgX2l0ZXJhYmxlRGF0YUFycmF5JDogU3ViamVjdDxhbnlbXT4gPSBuZXcgU3ViamVjdDxhbnlbXT4oKTtcblxuICBwdWJsaWMgcGFnaW5hdGlvbkluZm86IHtcbiAgICBmaXJzdEl0ZW06IG51bWJlcjtcbiAgICBsYXN0SXRlbTogbnVtYmVyO1xuICAgIGFsbEl0ZW1zOiBudW1iZXI7XG4gICAgYWN0aXZlUGFnZTogbnVtYmVyO1xuICB9ID0ge1xuICAgIGZpcnN0SXRlbTogMSxcbiAgICBsYXN0SXRlbTogdGhpcy5pdGVtc1BlclBhZ2UsXG4gICAgYWxsSXRlbXM6IHRoaXMuZGF0YUFycmF5VW5tb2RpZmllZC5sZW5ndGgsXG4gICAgYWN0aXZlUGFnZTogdGhpcy5jdXJyZW50UGFnZSxcbiAgfTtcblxuICBwdWJsaWMgc2V0IGRhdGFBcnJheShkYXRhOiBhbnlbXSkge1xuICAgIHRoaXMuX2RhdGFBcnJheSA9IGRhdGE7XG4gICAgdGhpcy5fZGF0YUFycmF5JC5uZXh0KHRoaXMuZGF0YUFycmF5KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGF0YUFycmF5KCk6IGFueVtdIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YUFycmF5O1xuICB9XG5cbiAgcHVibGljIGRhdGFBcnJheUNoYW5nZSgpOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGFBcnJheSQ7XG4gIH1cblxuICBwdWJsaWMgc2V0IGl0ZXJhYmxlRGF0YUFycmF5KGRhdGE6IGFueVtdKSB7XG4gICAgdGhpcy5faXRlcmFibGVEYXRhQXJyYXkgPSBkYXRhO1xuICAgIHRoaXMuX2l0ZXJhYmxlRGF0YUFycmF5JC5uZXh0KHRoaXMuaXRlcmFibGVEYXRhQXJyYXkpO1xuICB9XG5cbiAgcHVibGljIGdldCBpdGVyYWJsZURhdGFBcnJheSgpOiBhbnlbXSB7XG4gICAgcmV0dXJuIHRoaXMuX2l0ZXJhYmxlRGF0YUFycmF5O1xuICB9XG5cbiAgcHVibGljIGl0ZXJhYmxlRGF0YUFycmF5Q2hhbmdlKCk6IE9ic2VydmFibGU8YW55W10+IHtcbiAgICByZXR1cm4gdGhpcy5faXRlcmFibGVEYXRhQXJyYXkkO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7XG4gICAgdGhpcy5kYXRhQXJyYXlDaGFuZ2UoKVxuICAgICAgLnBpcGUoKVxuICAgICAgLnN1YnNjcmliZSgobmV3RGF0YTogYW55W10pID0+IHtcbiAgICAgICAgdGhpcy5kYXRhQXJyYXlVbm1vZGlmaWVkID0gbmV3RGF0YTtcblxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLml0ZXJhYmxlRGF0YUFycmF5ID0gdGhpcy5kYXRhQXJyYXlVbm1vZGlmaWVkLnNsaWNlKFxuICAgICAgICAgICAgdGhpcy5pdGVtc1BlclBhZ2UgKiAodGhpcy5jdXJyZW50UGFnZSAtIDEpLFxuICAgICAgICAgICAgdGhpcy5pdGVtc1BlclBhZ2UgKiAodGhpcy5jdXJyZW50UGFnZSAtIDEpICsgdGhpcy5pdGVtc1BlclBhZ2VcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuaXRlcmFibGVEYXRhQXJyYXk7XG4gICAgICAgICAgdGhpcy51cGRhdGVQYWdpbmF0aW9uSW5mbygpO1xuICAgICAgICB9LCAwKTtcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5pdGVyYWJsZURhdGFBcnJheUNoYW5nZSgpXG4gICAgICAucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmRhdGEgJiYgdGhpcy5fc2VhcmNoS2V5Lmxlbmd0aCA9PSAwICYmIHRoaXMuY3VycmVudFBhZ2UgPT0gMSkge1xuICAgICAgICAgIHRoaXMucGFnaW5hdGlvbkluZm8uZmlyc3RJdGVtID0gdGhpcy5kYXRhLmZpbmRJbmRleCgoZWw6IGFueSkgPT4gZWwgPT09IHRoaXMuZGF0YVswXSkgKyAxO1xuICAgICAgICAgIHRoaXMucGFnaW5hdGlvbkluZm8ubGFzdEl0ZW0gPVxuICAgICAgICAgICAgdGhpcy5kYXRhLmZpbmRJbmRleCgoZWw6IGFueSkgPT4gZWwgPT0gdGhpcy5kYXRhW3RoaXMuZGF0YS5sZW5ndGggLSAxXSkgKyAxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0aGlzLml0ZXJhYmxlRGF0YUFycmF5ICYmXG4gICAgICAgICAgdGhpcy5pdGVyYWJsZURhdGFBcnJheS5maW5kSW5kZXgoKGVsOiBhbnkpID0+IGVsID09IHRoaXMuaGlnaGxpZ2h0ZWRUYWJsZVJvdykgPT09IC0xXG4gICAgICAgICkge1xuICAgICAgICAgIGlmICh0aGlzLmhpZ2hsaWdodGVkVGFibGVSb3cgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0ZWRUYWJsZVJvdyA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLnJvd0hpZ2hsaWdodC5lbWl0KG51bGwpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICBjb25zdCBjbGljayQgPSBmcm9tRXZlbnQodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnY2xpY2snKTtcbiAgICBjbGljayQuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XG4gICAgICAvLyBXb3JrYXJvdW5kIGZvciBzaXR1YXRpb24gd2hlbiBmcm9tRXZlbnQgaXMgbm90IGFibGUgdG8gZW1pdCB2YWx1ZSBmcm9tIEV2ZW50RW1pdHRlclxuICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5tYXJrSGlnaGxpZ2h0QW5kRW1pdChldmVudCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlc1snaXRlbXNQZXJQYWdlJ10pIHtcbiAgICAgIHRoaXMuaXRlcmFibGVEYXRhQXJyYXkgPSB0aGlzLmRhdGFBcnJheVVubW9kaWZpZWQuc2xpY2UoXG4gICAgICAgIHRoaXMuaXRlbXNQZXJQYWdlICogKHRoaXMuY3VycmVudFBhZ2UgLSAxKSxcbiAgICAgICAgdGhpcy5pdGVtc1BlclBhZ2UgKiAodGhpcy5jdXJyZW50UGFnZSAtIDEpICsgdGhpcy5pdGVtc1BlclBhZ2VcbiAgICAgICk7XG4gICAgICBpZiAoIWNoYW5nZXNbJ2l0ZW1zUGVyUGFnZSddLmlzRmlyc3RDaGFuZ2UoKSkge1xuICAgICAgICB0aGlzLnVwZGF0ZVBhZ2luYXRpb25JbmZvKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNhbGN1bGF0ZVBhZ2VzTnVtYmVyKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGguY2VpbCh0aGlzLmRhdGFBcnJheVVubW9kaWZpZWQubGVuZ3RoIC8gdGhpcy5pdGVtc1BlclBhZ2UpO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZVBhZ2luYXRpb25JbmZvKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRhdGFBcnJheSkge1xuICAgICAgY29uc3QgZmlyc3RBbmRMYXN0SW5kZXhlcyA9IHtcbiAgICAgICAgZmlyc3Q6XG4gICAgICAgICAgdGhpcy5kYXRhQXJyYXkuZmluZEluZGV4KChlbDogYW55KSA9PiBlbCA9PT0gdGhpcy5pdGVyYWJsZURhdGFBcnJheVswXSkgKyAxIHx8XG4gICAgICAgICAgdGhpcy5pdGVyYWJsZURhdGFBcnJheS5maW5kSW5kZXgoKGVsOiBhbnkpID0+IGVsID09PSB0aGlzLml0ZXJhYmxlRGF0YUFycmF5WzBdKSArIDEsXG4gICAgICAgIGxhc3Q6XG4gICAgICAgICAgdGhpcy5kYXRhQXJyYXkuZmluZEluZGV4KFxuICAgICAgICAgICAgKGVsOiBhbnkpID0+IGVsID09PSB0aGlzLml0ZXJhYmxlRGF0YUFycmF5W3RoaXMuaXRlcmFibGVEYXRhQXJyYXkubGVuZ3RoIC0gMV1cbiAgICAgICAgICApICsgMSB8fFxuICAgICAgICAgIHRoaXMuaXRlcmFibGVEYXRhQXJyYXkuZmluZEluZGV4KFxuICAgICAgICAgICAgKGVsOiBhbnkpID0+IGVsID09PSB0aGlzLml0ZXJhYmxlRGF0YUFycmF5W3RoaXMuaXRlcmFibGVEYXRhQXJyYXkubGVuZ3RoIC0gMV1cbiAgICAgICAgICApICsgMSxcbiAgICAgIH07XG5cbiAgICAgIHRoaXMucGFnaW5hdGlvbkluZm8gPSB7XG4gICAgICAgIGZpcnN0SXRlbTogZmlyc3RBbmRMYXN0SW5kZXhlcy5maXJzdCxcbiAgICAgICAgbGFzdEl0ZW06IGZpcnN0QW5kTGFzdEluZGV4ZXMubGFzdCxcbiAgICAgICAgYWxsSXRlbXM6IHRoaXMuZGF0YUFycmF5VW5tb2RpZmllZC5sZW5ndGgsXG4gICAgICAgIGFjdGl2ZVBhZ2U6IHRoaXMuY3VycmVudFBhZ2UsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBuZXh0UGFnZShzd2l0Y2hUb0xhc3RQYWdlPzogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICh0aGlzLmN1cnJlbnRQYWdlIDwgdGhpcy5jYWxjdWxhdGVQYWdlc051bWJlcigpKSB7XG4gICAgICBpZiAoc3dpdGNoVG9MYXN0UGFnZSkge1xuICAgICAgICB0aGlzLmN1cnJlbnRQYWdlID0gdGhpcy5jYWxjdWxhdGVQYWdlc051bWJlcigpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jdXJyZW50UGFnZSsrO1xuICAgICAgfVxuICAgICAgdGhpcy5pdGVyYWJsZURhdGFBcnJheSA9IHRoaXMuZGF0YUFycmF5VW5tb2RpZmllZC5zbGljZShcbiAgICAgICAgdGhpcy5pdGVtc1BlclBhZ2UgKiAodGhpcy5jdXJyZW50UGFnZSAtIDEpLFxuICAgICAgICB0aGlzLml0ZW1zUGVyUGFnZSAqICh0aGlzLmN1cnJlbnRQYWdlIC0gMSkgKyB0aGlzLml0ZW1zUGVyUGFnZVxuICAgICAgKTtcbiAgICAgIHRoaXMudXBkYXRlUGFnaW5hdGlvbkluZm8oKTtcblxuICAgICAgY29uc3QgZmlyc3RBbmRMYXN0SW5kZXhlcyA9IHtcbiAgICAgICAgZmlyc3Q6IHRoaXMuZGF0YUFycmF5VW5tb2RpZmllZC5maW5kSW5kZXgoKGVsOiBhbnkpID0+IGVsID09IHRoaXMuaXRlcmFibGVEYXRhQXJyYXlbMF0pICsgMSxcbiAgICAgICAgbGFzdDpcbiAgICAgICAgICB0aGlzLmRhdGFBcnJheVVubW9kaWZpZWQuZmluZEluZGV4KFxuICAgICAgICAgICAgKGVsOiBhbnkpID0+IGVsID09IHRoaXMuaXRlcmFibGVEYXRhQXJyYXlbdGhpcy5pdGVyYWJsZURhdGFBcnJheS5sZW5ndGggLSAxXVxuICAgICAgICAgICkgKyAxLFxuICAgICAgfTtcblxuICAgICAgdGhpcy5wYWdpbmF0aW9uSW5mby5maXJzdEl0ZW0gPSBmaXJzdEFuZExhc3RJbmRleGVzLmZpcnN0O1xuICAgICAgdGhpcy5wYWdpbmF0aW9uSW5mby5sYXN0SXRlbSA9IGZpcnN0QW5kTGFzdEluZGV4ZXMubGFzdDtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcHJldlBhZ2Uoc3dpdGNoVG9GaXJzdFBhZ2U/OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY3VycmVudFBhZ2UgPiAxKSB7XG4gICAgICBpZiAoc3dpdGNoVG9GaXJzdFBhZ2UpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50UGFnZSA9IDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmN1cnJlbnRQYWdlLS07XG4gICAgICB9XG4gICAgICB0aGlzLml0ZXJhYmxlRGF0YUFycmF5ID0gdGhpcy5kYXRhQXJyYXlVbm1vZGlmaWVkLnNsaWNlKFxuICAgICAgICB0aGlzLml0ZW1zUGVyUGFnZSAqICh0aGlzLmN1cnJlbnRQYWdlIC0gMSksXG4gICAgICAgIHRoaXMuaXRlbXNQZXJQYWdlICogKHRoaXMuY3VycmVudFBhZ2UgLSAxKSArIHRoaXMuaXRlbXNQZXJQYWdlXG4gICAgICApO1xuICAgICAgdGhpcy51cGRhdGVQYWdpbmF0aW9uSW5mbygpO1xuICAgIH1cblxuICAgIGNvbnN0IGZpcnN0QW5kTGFzdEluZGV4ZXMgPSB7XG4gICAgICBmaXJzdDogdGhpcy5kYXRhQXJyYXlVbm1vZGlmaWVkLmZpbmRJbmRleCgoZWw6IGFueSkgPT4gZWwgPT0gdGhpcy5pdGVyYWJsZURhdGFBcnJheVswXSkgKyAxLFxuICAgICAgbGFzdDpcbiAgICAgICAgdGhpcy5kYXRhQXJyYXlVbm1vZGlmaWVkLmZpbmRJbmRleChcbiAgICAgICAgICAoZWw6IGFueSkgPT4gZWwgPT0gdGhpcy5pdGVyYWJsZURhdGFBcnJheVt0aGlzLml0ZXJhYmxlRGF0YUFycmF5Lmxlbmd0aCAtIDFdXG4gICAgICAgICkgKyAxLFxuICAgIH07XG5cbiAgICB0aGlzLnBhZ2luYXRpb25JbmZvLmZpcnN0SXRlbSA9IGZpcnN0QW5kTGFzdEluZGV4ZXMuZmlyc3Q7XG4gICAgdGhpcy5wYWdpbmF0aW9uSW5mby5sYXN0SXRlbSA9IGZpcnN0QW5kTGFzdEluZGV4ZXMubGFzdDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNhYmxlUHJldmlvdXMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFBhZ2UgPT09IDE7XG4gIH1cblxuICBwdWJsaWMgZGlzYWJsZU5leHQoKTogYm9vbGVhbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHRoaXMuZGF0YUFycmF5VW5tb2RpZmllZCkge1xuICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFBhZ2UgPj0gdGhpcy5jYWxjdWxhdGVQYWdlc051bWJlcigpIHx8IHRoaXMubmV4dFNob3VsZEJlRGlzYWJsZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmaWx0ZXJJdGVyYWJsZUFycmF5KHNlYXJjaEtleTogc3RyaW5nKTogYW55IHtcbiAgICBpZiAodGhpcy5kYXRhQXJyYXkpIHtcbiAgICAgIGNvbnN0IGZpbHRlciA9IHRoaXMuZGF0YUFycmF5LmZpbHRlcigob2JqOiBBcnJheTxhbnk+KSA9PiB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLnNvbWUoKGtleTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKG9ialtrZXldICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gb2JqW2tleV1cbiAgICAgICAgICAgICAgLnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICAgICAgLmluY2x1ZGVzKHNlYXJjaEtleSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLml0ZXJhYmxlRGF0YUFycmF5ID0gZmlsdGVyLnNsaWNlKFxuICAgICAgICB0aGlzLml0ZW1zUGVyUGFnZSAqICh0aGlzLmN1cnJlbnRQYWdlIC0gMSksXG4gICAgICAgIHRoaXMuaXRlbXNQZXJQYWdlICogKHRoaXMuY3VycmVudFBhZ2UgLSAxKSArIHRoaXMuaXRlbXNQZXJQYWdlXG4gICAgICApO1xuICAgICAgdGhpcy5uZXh0U2hvdWxkQmVEaXNhYmxlZCA9IHRoaXMuaXRlcmFibGVEYXRhQXJyYXkubGVuZ3RoIDwgdGhpcy5pdGVtc1BlclBhZ2U7XG4gICAgICB0aGlzLnVwZGF0ZVBhZ2luYXRpb25JbmZvKCk7XG4gICAgICByZXR1cm4gdGhpcy5pdGVyYWJsZURhdGFBcnJheTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcGVyZm9ybVNlYXJjaChzZWFyY2hLZXk6IHN0cmluZyk6IGFueSB7XG4gICAgdGhpcy5fc2VhcmNoS2V5ID0gc2VhcmNoS2V5O1xuXG4gICAgaWYgKCFzZWFyY2hLZXkgJiYgdGhpcy5kYXRhQXJyYXkpIHtcbiAgICAgIHRoaXMubmV4dFNob3VsZEJlRGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuZGF0YSA9IHRoaXMuZGF0YUFycmF5LnNsaWNlKFxuICAgICAgICB0aGlzLml0ZW1zUGVyUGFnZSAqICh0aGlzLmN1cnJlbnRQYWdlIC0gMSksXG4gICAgICAgIHRoaXMuaXRlbXNQZXJQYWdlICogKHRoaXMuY3VycmVudFBhZ2UgLSAxKSArIHRoaXMuaXRlbXNQZXJQYWdlXG4gICAgICApO1xuICAgICAgdGhpcy5faXRlcmFibGVEYXRhQXJyYXkkLm5leHQodGhpcy5kYXRhKTtcbiAgICAgIHJldHVybiB0aGlzLmRhdGFBcnJheS5zbGljZShcbiAgICAgICAgdGhpcy5pdGVtc1BlclBhZ2UgKiAodGhpcy5jdXJyZW50UGFnZSAtIDEpLFxuICAgICAgICB0aGlzLml0ZW1zUGVyUGFnZSAqICh0aGlzLmN1cnJlbnRQYWdlIC0gMSkgKyB0aGlzLml0ZW1zUGVyUGFnZVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kYXRhID0gdGhpcy5maWx0ZXJJdGVyYWJsZUFycmF5KHNlYXJjaEtleS50b0xvd2VyQ2FzZSgpKTtcbiAgICAgIHJldHVybiB0aGlzLmZpbHRlckl0ZXJhYmxlQXJyYXkoc2VhcmNoS2V5LnRvTG93ZXJDYXNlKCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzb3J0QXJyYXkocHJvcGVydHk6IHN0cmluZyk6IGFueSB7XG4gICAgdGhpcy5kYXRhQXJyYXkgPSB0aGlzLmRhdGFBcnJheVVubW9kaWZpZWQuc2xpY2UoKTtcbiAgICB0aGlzLmlzRGVzYyA9ICF0aGlzLmlzRGVzYzsgLy9jaGFuZ2UgdGhlIGRpcmVjdGlvblxuICAgIHByb3BlcnR5ID0gcHJvcGVydHkucmVwbGFjZSgvIC9nLCAnXycpLnRvTG93ZXJDYXNlKCk7XG4gICAgY29uc3QgZGlyZWN0aW9uID0gdGhpcy5pc0Rlc2MgPyAxIDogLTE7XG4gICAgdGhpcy5kYXRhQXJyYXkuc29ydCgoYSwgYikgPT4ge1xuICAgICAgaWYgKGFbcHJvcGVydHldIDwgYltwcm9wZXJ0eV0pIHtcbiAgICAgICAgcmV0dXJuIC0xICogZGlyZWN0aW9uO1xuICAgICAgfSBlbHNlIGlmIChhW3Byb3BlcnR5XSA+IGJbcHJvcGVydHldKSB7XG4gICAgICAgIHJldHVybiAxICogZGlyZWN0aW9uO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRDbG9zZXN0RWwoZWw6IGFueSwgc2VsZWN0b3I6IHN0cmluZyk6IGFueSB7XG4gICAgZm9yICg7IGVsICYmIGVsICE9PSBkb2N1bWVudDsgZWwgPSBlbC5wYXJlbnROb2RlKSB7XG4gICAgICBpZiAoZWwubWF0Y2hlcyAmJiBlbC5tYXRjaGVzKHNlbGVjdG9yKSkge1xuICAgICAgICByZXR1cm4gZWw7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXJrSGlnaGxpZ2h0QW5kRW1pdChldmVudDogYW55KSB7XG4gICAgY29uc3QgdGFibGVSb3cgPSB0aGlzLl9nZXRDbG9zZXN0RWwoZXZlbnQudGFyZ2V0LCAndHInKTtcbiAgICBjb25zdCB0Ym9keSA9IHRoaXMuX2dldENsb3Nlc3RFbChldmVudC50YXJnZXQsICd0Ym9keScpO1xuXG4gICAgaWYgKHRib2R5ICYmIGV2ZW50LnRhcmdldCkge1xuICAgICAgdGJvZHkuY2hpbGROb2Rlcy5mb3JFYWNoKChyb3c6IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBpZiAocm93ID09PSB0YWJsZVJvdykge1xuICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0ZWRUYWJsZVJvdyA9IHRoaXMuaXRlcmFibGVEYXRhQXJyYXlbaW5kZXhdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJvdyAhPT0gdGFibGVSb3cpIHtcbiAgICAgICAgICBpZiAocm93LmNsYXNzTGlzdCAmJiByb3cuY2xhc3NMaXN0LmNvbnRhaW5zKCd0ci1jb2xvci1zZWxlY3RlZCcpKSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHJvdywgJ3RyLWNvbG9yLXNlbGVjdGVkJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMucm93SGlnaGxpZ2h0LmVtaXQodGhpcy5oaWdobGlnaHRlZFRhYmxlUm93KTtcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGFibGVSb3csICd0ci1jb2xvci1zZWxlY3RlZCcpO1xuICAgIH1cbiAgfVxufVxuIl19